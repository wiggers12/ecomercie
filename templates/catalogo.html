<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Cat√°logo ‚Äî Ecomercie</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">

  <style>
    :root{
      --pri:#007BFF; --sec:#1a3d5f; --ok:#28a745; --err:#dc3545;
      --bg:#f4f6f9; --fg:#333; --card:#fff; --shadow:0 4px 12px rgba(0,0,0,.08);
      --r:12px; --font:'Poppins',system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--fg);font-family:var(--font)}
    header{background:#fff;padding:20px 5%;box-shadow:var(--shadow);display:flex;gap:20px;align-items:center;justify-content:space-between;flex-wrap:wrap;position:sticky;top:0;z-index:1000}
    h1{margin:0;color:var(--pri);font-size:1.8rem;font-weight:700}
    .search-container{flex:1;min-width:240px;max-width:520px}
    #search-input{width:100%;padding:12px 16px;border:1px solid #e5e7eb;border-radius:10px;font:inherit}

    main{padding:30px 5%}
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:22px}

    .card{background:var(--card);border-radius:var(--r);box-shadow:var(--shadow);overflow:hidden;display:flex;flex-direction:column;transition:.25s transform,.25s box-shadow}
    .card:hover{transform:translateY(-6px);box-shadow:0 10px 20px rgba(0,0,0,.12)}
    .hero{width:100%;height:180px;object-fit:cover}
    .noimg{height:180px;display:flex;align-items:center;justify-content:center;background:#eef2f6;color:#6b7280;font-weight:600}
    .card-content{padding:14px;display:flex;flex-direction:column;gap:8px}
    .card h3{margin:0;font-size:1.05rem}
    .desc{color:#636b74;font-size:.92rem;line-height:1.35;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden}
    .price{font-size:1.25rem;font-weight:700;color:var(--pri);margin-top:auto}
    .row{display:flex;gap:8px}
    .btn{border:0;border-radius:10px;padding:10px 12px;font-weight:700;cursor:pointer}
    .btn.pri{background:var(--pri);color:#fff}
    .btn.sec{background:#eef3ff;color:#0b1220}
    .pill{display:inline-block;padding:4px 8px;border-radius:999px;font-size:12px}
    .pill.out{background:#ffe8e8;color:#b42318;font-weight:700}

    /* Carrinho flutuante (ESQUERDA) */
    .cart-icon{position:fixed;left:20px;bottom:20px;width:60px;height:60px;border-radius:50%;background:var(--pri);color:#fff;display:flex;align-items:center;justify-content:center;font-size:28px;cursor:pointer;box-shadow:0 8px 20px rgba(0,123,255,.35);z-index:1010;transition:.2s transform}
    .cart-icon:hover{transform:scale(1.06)}
    .cart-count{position:absolute;right:-6px;top:-6px;background:var(--err);color:#fff;width:22px;height:22px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:12px;font-weight:700}

    .cart-sidebar{position:fixed;top:0;right:-100%;width:100%;max-width:400px;height:100%;background:#fff;box-shadow:-6px 0 20px rgba(0,0,0,.15);transition:right .35s ease;z-index:1020;display:flex;flex-direction:column}
    .cart-sidebar.open{right:0}
    .cart-header{padding:18px;border-bottom:1px solid #eee;display:flex;justify-content:space-between;align-items:center}
    .close-cart-btn{background:none;border:0;font-size:2rem;cursor:pointer}
    #cart-items{flex:1;overflow-y:auto;padding:18px}
    .cart-item{display:flex;gap:12px;align-items:center;margin-bottom:16px}
    .cart-item img{width:80px;height:80px;border-radius:10px;object-fit:cover}
    .cart-item-info h4{margin:0 0 4px 0}
    .qty{font-size:.95rem;color:#64748b}
    .remove-item-btn{background:none;border:0;color:var(--err);font-size:1.6rem;cursor:pointer}
    .cart-footer{padding:18px;border-top:1px solid #eee}
    .cart-total{display:flex;justify-content:space-between;font-size:1.15rem;font-weight:700;margin-bottom:12px}
    .checkout-btn{width:100%;padding:14px;background:var(--ok);border:0;border-radius:10px;color:#fff;font-weight:700;cursor:pointer}

    /* Modal Detalhes */
    .overlay{position:fixed;inset:0;background:rgba(17,24,39,.55);display:none;align-items:center;justify-content:center;z-index:1100}
    .overlay.open{display:flex}
    .modal{background:#fff;border-radius:14px;box-shadow:var(--shadow);width:min(860px,94vw);max-height:94vh;overflow:auto}
    .modal header{display:flex;justify-content:space-between;align-items:center;padding:14px 16px;border-bottom:1px solid #eee}
    .modal .content{padding:16px}
    .gallery{display:flex;gap:8px;flex-wrap:wrap}
    .gimg{width:140px;height:140px;border-radius:10px;object-fit:cover}
    video{max-width:100%;border-radius:10px;background:#000}

    /* Bot√µes sociais (esquerda, meio) */
    .social-buttons{position:fixed;left:0;top:50%;transform:translateY(-50%);display:flex;flex-direction:column;gap:6px;z-index:1000}
    .social-btn{width:46px;height:46px;display:flex;align-items:center;justify-content:center;color:#fff;text-decoration:none;border-top-right-radius:12px;border-bottom-right-radius:12px;transition:transform .2s}
    .social-btn:hover{transform:translateX(4px)}
    .whatsapp{background:#25D366}
    .instagram{background:radial-gradient(circle at 30% 107%,#fdf497 0%,#fdf497 5%,#fd5949 45%,#d6249f 60%,#285AEB 90%)}
    .facebook{background:#1877F2}

    @media (max-width:600px){
      main{padding:22px 14px}
      .grid{grid-template-columns:repeat(2,1fr);gap:14px}
      .cart-sidebar{max-width:100%}
    }
  </style>
</head>
<body>

  <header>
    <h1>Meu Cat√°logo</h1>
    <div class="search-container">
      <input id="search-input" type="text" placeholder="O que voc√™ est√° procurando?">
    </div>
  </header>

  <main>
    <div id="product-grid" class="grid">
      <!-- NENHUM item fixo. Tudo vem do Firestore. -->
    </div>
  </main>

  <!-- Bot√µes sociais -->
  <div class="social-buttons">
    <a class="social-btn whatsapp"  target="_blank" rel="noopener" href="https://wa.me/5551989378751" aria-label="WhatsApp">WA</a>
    <a class="social-btn instagram" target="_blank" rel="noopener" href="https://instagram.com/analise_desenvolvimento_web" aria-label="Instagram">IG</a>
    <a class="social-btn facebook"  target="_blank" rel="noopener" href="https://facebook.com/" aria-label="Facebook">FB</a>
  </div>

  <!-- Bot√£o + Sidebar do carrinho -->
  <div class="cart-icon" id="cart-icon">üõí <span id="cart-count" class="cart-count">0</span></div>

  <div id="cart-sidebar" class="cart-sidebar">
    <div class="cart-header">
      <h2>Meu Carrinho</h2>
      <button id="close-cart-btn" class="close-cart-btn">&times;</button>
    </div>
    <div id="cart-items"><p id="cart-empty-message" style="text-align:center;color:#888;margin-top:40px">Seu carrinho est√° vazio.</p></div>
    <div class="cart-footer">
      <div class="cart-total"><span>Total:</span><span id="cart-total">R$ 0,00</span></div>
      <button id="checkout-btn" class="checkout-btn">Finalizar Compra</button>
    </div>
  </div>

  <!-- Modal de detalhes -->
  <div id="dlg" class="overlay">
    <div class="modal">
      <header><b id="dlgTitle">Detalhes</b><button id="dlgClose" class="close-cart-btn" aria-label="Fechar">&times;</button></header>
      <div class="content">
        <div class="gallery" id="dlgGallery"></div>
        <div id="dlgVideoWrap" style="margin-top:12px;display:none">
          <video id="dlgVideo" controls playsinline></video>
        </div>
        <p id="dlgDesc" style="margin-top:12px;color:#4b5563"></p>
        <div class="row" style="margin-top:12px">
          <span id="dlgPrice" class="price"></span>
          <button id="dlgAdd" class="btn pri" style="margin-left:auto">Adicionar ao carrinho</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Tawk.to -->
  <script type="text/javascript">
    var Tawk_API=Tawk_API||{}, Tawk_LoadStart=new Date();
    (function(){
      var s1=document.createElement("script"),s0=document.getElementsByTagName("script")[0];
      s1.async=true; s1.src='https://embed.tawk.to/68b7b09d721af15d8752e01d/1j46ojqe8';
      s1.charset='UTF-8'; s1.setAttribute('crossorigin','*'); s0.parentNode.insertBefore(s1,s0);
    })();
  </script>

  <!-- Firebase + cat√°logo -->
  <script type="module">
    import { db } from "/static/firebase-init.js";
    import {
      collection, onSnapshot, query, where, orderBy, addDoc,
      serverTimestamp, doc, updateDoc, increment
    } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-firestore.js";

    // ---------- Utils ----------
    const grid = document.getElementById('product-grid');
    const searchInput = document.getElementById('search-input');
    const fmtBRL = n => (Number(n)||0).toLocaleString('pt-BR',{style:'currency',currency:'BRL'});
    function tenant(){
      const p = location.pathname.split('/').filter(Boolean);
      return (p.length>=2 && ['admin','catalogo','estoque','financeiro'].includes(p[1])) ? p[0] : 'default';
    }
    const TENANT = tenant();

    // ---------- Modal ----------
    const dlg = document.getElementById('dlg');
    const dlgTitle = document.getElementById('dlgTitle');
    const dlgGallery = document.getElementById('dlgGallery');
    const dlgVideoWrap = document.getElementById('dlgVideoWrap');
    const dlgVideo = document.getElementById('dlgVideo');
    const dlgDesc = document.getElementById('dlgDesc');
    const dlgPrice = document.getElementById('dlgPrice');
    const dlgAdd = document.getElementById('dlgAdd');
    document.getElementById('dlgClose').onclick = ()=> dlg.classList.remove('open');
    let dlgProduct = null;

    function openDlg(p){
      dlgProduct = p;
      dlgTitle.textContent = p.name || 'Detalhes';
      dlgGallery.innerHTML = '';
      (p.images||[]).forEach(u=>{
        const im = document.createElement('img');
        im.src=u; im.className='gimg';
        dlgGallery.appendChild(im);
      });
      if (p.video){
        dlgVideo.src = p.video;
        dlgVideoWrap.style.display = '';
      }else{
        dlgVideo.removeAttribute('src');
        dlgVideoWrap.style.display = 'none';
      }
      dlgDesc.textContent = p.desc || '';
      dlgPrice.textContent = fmtBRL(p.price||0);
      dlg.classList.add('open');
    }
    dlgAdd.onclick = ()=>{
      if (!dlgProduct) return;
      addToCartFromProduct(dlgProduct);
      dlg.classList.remove('open');
    };

    // ---------- Render dos produtos do Firestore ----------
    function renderProductCard(p){
      const el = document.createElement('div');
      el.className = 'card';
      el.dataset.name = (p.name||'').toLowerCase();

      const hasImg = Array.isArray(p.images) && p.images.length>0;
      const imgHtml = hasImg ? `<img class="hero" src="${p.images[0]}" alt="${p.name||''}">`
                             : `<div class="noimg">Sem imagem</div>`;

      el.innerHTML = `
        ${imgHtml}
        <div class="card-content">
          <h3>${p.name||''}</h3>
          ${p.desc ? `<div class="desc">${p.desc}</div>` : ``}
          ${p.stock > 0 ? `<div class="price">${fmtBRL(p.price||0)}</div>` : `<span class="pill out">Esgotado</span>`}
          <div class="row">
            <button class="btn sec" data-action="detalhes">Detalhes</button>
            <button class="btn pri" data-action="add" ${p.stock>0?'':'disabled'}>Adicionar</button>
          </div>
        </div>
      `;
      // listeners de card
      el.querySelector('[data-action="detalhes"]').onclick = ()=> openDlg(p);
      el.querySelector('[data-action="add"]').onclick = ()=> addToCartFromProduct(p);
      return el;
    }

    const qProducts = query(
      collection(db, `tenants/${TENANT}/products`),
      where('active','==', true),
      orderBy('name', 'asc')
    );

    let PRODUCTS = []; // cache p/ busca
    onSnapshot(qProducts, snap=>{
      PRODUCTS = [];
      grid.innerHTML = ''; // limpa tudo (garante que nada fixo apare√ßa)
      snap.forEach(d=>{
        const p = { id: d.id, ...d.data() };
        // se existir campo stock, esconda os com 0
        if (typeof p.stock === 'number' && p.stock <= 0) return;
        PRODUCTS.push(p);
        grid.appendChild(renderProductCard(p));
      });
    });

    // ---------- Busca nos cards ----------
    searchInput.addEventListener('input', e=>{
      const term = e.target.value.trim().toLowerCase();
      grid.querySelectorAll('.card').forEach(card=>{
        const name = card.dataset.name || '';
        card.style.display = name.includes(term) ? '' : 'none';
      });
    });

    // ---------- Carrinho ----------
    const cartIcon   = document.getElementById('cart-icon');
    const cartSidebar= document.getElementById('cart-sidebar');
    const closeCart  = document.getElementById('close-cart-btn');
    const cartItems  = document.getElementById('cart-items');
    const cartCount  = document.getElementById('cart-count');
    const cartTotal  = document.getElementById('cart-total');
    const emptyMsg   = document.getElementById('cart-empty-message');
    const checkout   = document.getElementById('checkout-btn');

    const cart = new Map(); // id -> {id,name,price,image,qty}

    function renderCart(){
      cartItems.innerHTML = '';
      const items = Array.from(cart.values());
      if (!items.length){
        emptyMsg.style.display = 'block';
      }else{
        emptyMsg.style.display = 'none';
        for (const it of items){
          const el = document.createElement('div');
          el.className='cart-item';
          el.innerHTML = `
            <img src="${it.image||''}" alt="${it.name}">
            <div class="cart-item-info">
              <h4>${it.name}</h4>
              <div class="qty">Qtd: ${it.qty}</div>
              <p>${fmtBRL(it.price)}</p>
            </div>
            <button class="remove-item-btn" title="Remover" data-id="${it.id}">&times;</button>
          `;
          cartItems.appendChild(el);
        }
      }
      const totalQty = items.reduce((s,i)=>s+i.qty,0);
      cartCount.textContent = totalQty;
      const totalVal = items.reduce((s,i)=>s + (i.price*i.qty),0);
      cartTotal.textContent = fmtBRL(totalVal);
    }

    function addToCartFromProduct(p){
      const id = p.id;
      const item = {
        id,
        name:  p.name || 'Produto',
        price: Number(p.price||0),
        image: (p.images && p.images[0]) || ''
      };
      const cur = cart.get(id);
      cart.set(id, {...item, qty: (cur?.qty||0)+1});
      renderCart();
      cartSidebar.classList.add('open');
    }

    cartItems.addEventListener('click', (e)=>{
      if (!e.target.classList.contains('remove-item-btn')) return;
      const id = e.target.dataset.id;
      cart.delete(id);
      renderCart();
    });

    cartIcon.addEventListener('click', ()=>cartSidebar.classList.add('open'));
    closeCart.addEventListener('click', ()=>cartSidebar.classList.remove('open'));

    // ---------- Finalizar compra (salva pedido e decrementa estoque) ----------
    checkout.addEventListener('click', async ()=>{
      const items = Array.from(cart.values());
      if (!items.length){ alert('Seu carrinho est√° vazio.'); return; }
      const total = items.reduce((s,i)=>s + i.price*i.qty, 0);

      await addDoc(collection(db, `tenants/${TENANT}/orders`), {
        items, total, status:'new', createdAt: serverTimestamp()
      });

      for (const it of items){
        try{ await updateDoc(doc(db, `tenants/${TENANT}/products/${it.id}`), { stock: increment(-it.qty) }); }catch(_){}
      }

      alert('Pedido registrado! (simula√ß√£o)');
      cart.clear();
      renderCart();
      cartSidebar.classList.remove('open');
    });

    renderCart();
  </script>
</body>
</html>