<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Nosso Cat√°logo</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root { --primary:#0d6efd; --dark:#1c1c1c; --light:#f8f9fa; --accent:#ffc107; }
    * { box-sizing: border-box; margin:0; padding:0; }
    body { font-family:'Poppins',sans-serif; background:var(--light); }

    /* Header */
    header { background:var(--dark); color:white; text-align:center; padding:20px; font-size:1.5em; font-weight:600; }

    /* Container */
    .container { max-width:1200px; margin:auto; padding:20px; }

    /* Barra de pesquisa */
    .search-bar { width:100%; padding:12px; font-size:16px; border:2px solid #ddd; border-radius:8px; margin-bottom:20px; }

    /* Grid */
    .product-grid { display:grid; grid-template-columns:repeat(auto-fill,minmax(180px,1fr)); gap:15px; }
    .product-card { background:white; border-radius:10px; box-shadow:0 3px 8px rgba(0,0,0,0.1); overflow:hidden; transition:.3s; cursor:pointer; }
    .product-card:hover { transform:scale(1.05); box-shadow:0 6px 18px rgba(0,0,0,0.2); }
    .product-card img { width:100%; height:100px; object-fit:cover; }
    .product-info { padding:10px; text-align:center; }
    .product-info h3 { font-size:14px; margin-bottom:5px; color:var(--dark); }
    .product-info p { font-size:16px; font-weight:600; color:var(--primary); margin:0; }

    /* Modal */
    .modal { position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.7);display:flex;align-items:center;justify-content:center;z-index:1000;opacity:0;visibility:hidden;transition:.3s; }
    .modal.active { opacity:1; visibility:visible; }
    .modal-content { background:white; padding:20px; border-radius:8px; width:90%; max-width:600px; max-height:90vh; overflow-y:auto; }
    .modal-content img { width:100%; border-radius:8px; }
    .modal-content h2 { margin:15px 0 5px; color:var(--dark); }
    .modal-price { font-size:20px; font-weight:700; color:var(--primary); margin:10px 0; }
    .modal-description { color:#444; line-height:1.5; margin-bottom:15px; }
    .modal-video { width:100%; aspect-ratio:16/9; border:none; margin-top:15px; border-radius:6px; }
    .close-btn { background:var(--dark); color:white; border:none; border-radius:6px; padding:8px 14px; cursor:pointer; }

    /* Carrinho flutuante */
    .cart { position:fixed; bottom:20px; right:20px; background:white; border:2px solid var(--primary); border-radius:12px; padding:15px; width:300px; max-height:60vh; overflow-y:auto; box-shadow:0 4px 12px rgba(0,0,0,.2); z-index:1100; }
    .cart h3 { margin:0 0 10px; font-size:16px; color:var(--dark); }
    .cart-item { display:flex; justify-content:space-between; margin-bottom:8px; font-size:14px; }
    .cart-total { font-weight:700; margin-top:10px; font-size:16px; }
    .payment-options { margin-top:10px; }
    .payment-options button { width:100%; margin-top:8px; padding:10px; border:none; border-radius:8px; font-weight:600; cursor:pointer; }
    .btn-credit { background:#198754; color:white; }
    .btn-debit { background:#0dcaf0; color:white; }
    .btn-pix { background:#6f42c1; color:white; }

    /* Bot√µes sociais */
    .social-buttons { position:fixed; bottom:20px; left:20px; display:flex; flex-direction:column; gap:10px; z-index:1200; }
    .social-buttons a { display:flex; align-items:center; justify-content:center; width:45px; height:45px; border-radius:50%; color:white; font-size:20px; text-decoration:none; }
    .whatsapp { background:#25d366; }
    .instagram { background:#e1306c; }
    .facebook { background:#1877f2; }
  </style>
</head>
<body>

<header>Conhe√ßa Nossos Produtos</header>

<main class="container">
  <input type="text" id="search-input" class="search-bar" placeholder="üîé O que voc√™ procura?">
  <div id="product-grid" class="product-grid"><p>Carregando produtos...</p></div>
</main>

<!-- Carrinho -->
<div id="cart" class="cart" style="display:none;">
  <h3>üõí Carrinho</h3>
  <div id="cart-items"></div>
  <p class="cart-total">Total: R$ 0,00</p>
  <div class="payment-options">
    <button class="btn-credit">üí≥ Cr√©dito</button>
    <button class="btn-debit">üèß D√©bito</button>
    <button class="btn-pix">‚ö° Pix</button>
  </div>
</div>

<!-- Bot√µes sociais -->
<div class="social-buttons">
  <a href="https://wa.me/5551989378751" target="_blank" class="whatsapp"><i class="fa fa-whatsapp"></i></a>
  <a href="https://instagram.com/analise_desenvolvimento_web" target="_blank" class="instagram"><i class="fa fa-instagram"></i></a>
  <a href="https://facebook.com" target="_blank" class="facebook"><i class="fa fa-facebook"></i></a>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/js/all.min.js"></script>
<script>
  const ownerId = '{{ owner_id }}';
  let allProducts = [];
  let cart = [];

  document.addEventListener('DOMContentLoaded', initializeCatalog);

  async function initializeCatalog() {
    try {
      // Notifica visita
      await fetch('/api/notify_visit', { 
        method: 'POST',
        body: JSON.stringify({ ownerId }),
        headers:{'Content-Type':'application/json'}
      });

      // Carrega produtos
      const res = await fetch(`/api/catalog_data/${ownerId}`);
      if (!res.ok) throw new Error("Erro ao carregar produtos");
      const data = await res.json();
      allProducts = data.products;
      renderCatalog(allProducts);
    } catch (err) {
      document.getElementById('product-grid').innerHTML="<p style='color:red;'>Erro ao carregar cat√°logo.</p>";
    }
  }

  function renderCatalog(products) {
    const grid=document.getElementById('product-grid');
    if(!products.length){ grid.innerHTML="<p>Nenhum produto encontrado.</p>"; return; }
    grid.innerHTML=products.map(p=>`
      <div class="product-card">
        <img src="${p.imagemUrl || 'https://via.placeholder.com/200x100'}" alt="${p.nome}">
        <div class="product-info">
          <h3>${p.nome}</h3>
          <p>R$ ${(p.valor||0).toFixed(2)}</p>
          <button onclick="addToCart('${p.id}','${p.nome}',${p.valor||0})">Adicionar</button>
        </div>
      </div>
    `).join('');
  }

  function addToCart(id,nome,valor){
    cart.push({id,nome,valor});
    updateCart();
  }

  function updateCart(){
    const cartDiv=document.getElementById('cart');
    const itemsDiv=document.getElementById('cart-items');
    let total=0;
    itemsDiv.innerHTML="";
    cart.forEach(item=>{
      total+=item.valor;
      itemsDiv.innerHTML+=`<div class="cart-item"><span>${item.nome}</span><span>R$ ${item.valor.toFixed(2)}</span></div>`;
    });
    document.querySelector('.cart-total').innerText="Total: R$ "+total.toFixed(2);
    cartDiv.style.display="block";
  }

  // Modal de detalhes
  async function showProductDetail(productId){
    const res=await fetch(`/api/products/${productId}`);
    if(!res.ok) return;
    const product=await res.json();
    let videoContent='';
    if(product.videoUrl){
      if(product.videoUrl.includes('firebasestorage')) videoContent=`<video class="modal-video" controls src="${product.videoUrl}"></video>`;
      else if(product.videoUrl.includes('youtu')) videoContent=`<iframe class="modal-video" src="${convertToEmbedUrl(product.videoUrl)}" allowfullscreen></iframe>`;
    }
    const modalHtml=`
      <div class="modal active" id="detail-modal" onclick="closeModal('detail-modal')">
        <div class="modal-content" onclick="event.stopPropagation()">
          <img src="${product.imagemUrl}" alt="${product.nome}">
          <h2>${product.nome}</h2>
          <p class="modal-price">R$ ${(product.valor||0).toFixed(2)}</p>
          <p class="modal-description">${product.descricao||'Sem descri√ß√£o.'}</p>
          ${videoContent}
          <button class="close-btn" onclick="closeModal('detail-modal')">Fechar</button>
        </div>
      </div>`;
    document.body.insertAdjacentHTML('beforeend',modalHtml);
  }

  function convertToEmbedUrl(url){
    if(url.includes("youtu.be/")) return `https://www.youtube.com/embed/${url.split("/").pop()}`;
    if(url.includes("watch?v=")) return `https://www.youtube.com/embed/${new URL(url).searchParams.get("v")}`;
    return url;
  }

  function closeModal(id){
    const modal=document.getElementById(id);
    if(modal) modal.remove();
  }

  // Pesquisa
  document.getElementById('search-input').addEventListener('input',(e)=>{
    const term=e.target.value.toLowerCase();
    const filtered=allProducts.filter(p=>p.nome?.toLowerCase().includes(term)||p.descricao?.toLowerCase().includes(term));
    renderCatalog(filtered);
  });
</script>
</body>
</html>
