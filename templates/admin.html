<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Painel Admin</title>
  <link rel="manifest" href="/manifest.json" />
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">

  <style>
    body { margin:0; font-family:Poppins,sans-serif; background:#f4f4f4; }
    .header { background:#2c3e50; color:#fff; padding:20px; display:flex; justify-content:space-between; align-items:center; }
    h1 { margin:0; }
    .btn { padding:10px 15px; border:none; border-radius:6px; cursor:pointer; font-weight:600; }
    .btn-primary { background:#3498db; color:#fff; }
    .btn-danger { background:#e74c3c; color:#fff; }
    .tabs { display:flex; background:#ecf0f1; }
    .tab { flex:1; padding:12px; text-align:center; cursor:pointer; font-weight:600; }
    .tab.active { background:#fff; border-bottom:3px solid #3498db; }
    .section { display:none; padding:20px; }
    .section.active { display:block; }

    /* Produtos */
    .table { width:100%; margin-top:20px; border-collapse:collapse; background:#fff; }
    .table th,.table td { padding:12px; border:1px solid #ddd; text-align:left; }

    /* Chat */
    .chat-container { display:flex; height:70vh; border:1px solid #ccc; border-radius:8px; overflow:hidden; background:#fff; }
    .chat-sessions { width:260px; background:#2c3e50; color:#fff; padding:10px; overflow-y:auto; }
    .chat-sessions h3 { margin:0 0 10px; text-align:center; }
    .session { background:#34495e; padding:10px; border-radius:6px; margin-bottom:8px; cursor:pointer; }
    .session:hover { background:#3d566e; }
    .session.active { background:#3498db; }
    .chat-box { flex:1; display:flex; flex-direction:column; }
    .chat-header { background:#3498db; color:#fff; padding:10px; font-weight:600; }
    .chat-messages { flex:1; padding:10px; overflow-y:auto; display:flex; flex-direction:column; }
    .msg { margin:6px 0; padding:8px 12px; border-radius:10px; max-width:70%; word-wrap:break-word; }
    .msg.user { background:#ecf0f1; align-self:flex-start; }
    .msg.admin { background:#3498db; color:#fff; align-self:flex-end; }
    .chat-input { display:flex; border-top:1px solid #ddd; padding:10px; }
    .chat-input input { flex:1; padding:10px; border:1px solid #ccc; border-radius:8px; }
    .chat-input button { margin-left:8px; background:#3498db; color:#fff; border:none; border-radius:8px; padding:10px 18px; cursor:pointer; font-weight:600; }
  </style>
</head>
<body>
  <div class="header">
    <h1>Painel Admin</h1>
    <div>
      <button id="btnPermissao" class="btn btn-primary">ðŸ”” Permitir NotificaÃ§Ãµes</button>
      <button class="btn btn-primary" onclick="openProductModal()">+ Novo Produto</button>
      <button class="btn btn-danger" onclick="logout()">Sair</button>
    </div>
  </div>

  <!-- Tabs -->
  <div class="tabs">
    <div class="tab active" onclick="showSection('produtos')">ðŸ“¦ Produtos</div>
    <div class="tab" onclick="showSection('chat')">ðŸ’¬ Chat</div>
  </div>

  <!-- ConteÃºdo -->
  <div class="section active" id="produtos">
    <h2>Meus Produtos</h2>
    <div id="products-table-container"></div>
  </div>

  <div class="section" id="chat">
    <h2>Conversas com Clientes</h2>
    <div class="chat-container">
      <div class="chat-sessions">
        <h3>SessÃµes</h3>
        <div id="sessions">Carregando...</div>
      </div>
      <div class="chat-box">
        <div class="chat-header" id="chat-header">Selecione uma sessÃ£o</div>
        <div class="chat-messages" id="chat-messages"></div>
        <div class="chat-input">
          <input type="text" id="chat-text" placeholder="Digite sua mensagem..." disabled>
          <button onclick="sendMessage()" id="send-btn" disabled>Enviar</button>
        </div>
      </div>
    </div>
  </div>

  <div id="toast-container" class="toast-container"></div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
  import { getFirestore } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
  import { getStorage, ref, uploadBytesResumable, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js";
  import { getMessaging, getToken, onMessage } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-messaging.js";

  const firebaseConfig = {
    apiKey: "AIzaSyB-rnG4cIZzEb1w_h_qmif3XPSx28ZIdaM",
    authDomain: "ecomercie-vendas.firebaseapp.com",
    projectId: "ecomercie-vendas",
    storageBucket: "ecomercie-vendas.firebasestorage.app",
    messagingSenderId: "1054540261609",
    appId: "1:1054540261609:web:90042b823220b4c73f6878",
    measurementId: "G-TNC5M9G89H"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);
  const storage = getStorage(app);
  const messaging = getMessaging(app);

  // --- Tabs
  function showSection(id){
    document.querySelectorAll(".section").forEach(s=>s.classList.remove("active"));
    document.querySelectorAll(".tab").forEach(t=>t.classList.remove("active"));
    document.getElementById(id).classList.add("active");
    document.querySelector(`.tab[onclick="showSection('${id}')"]`).classList.add("active");
  }
  window.showSection = showSection;

  // ---- PRODUTOS ----
  async function renderProductsTable() {
    const user = auth.currentUser;
    if (!user) return;
    const idToken = await user.getIdToken();
    const res = await fetch("/api/my_products", { headers: { "Authorization": "Bearer " + idToken } });
    const products = await res.json();
    let html = `<table class="table"><tr><th>Nome</th><th>PreÃ§o</th><th>Imagem</th></tr>`;
    products.forEach(p => {
      html += `<tr>
        <td>${p.nome}</td>
        <td>R$ ${(p.valor||0).toFixed(2)}</td>
        <td>${p.imagemUrl ? `<img src="${p.imagemUrl}" width="60">` : "-"}</td>
      </tr>`;
    });
    html += `</table>`;
    document.getElementById("products-table-container").innerHTML = html;
  }

  // ---- CHAT ----
  let selectedSession = null;

  async function loadSessions(){
    try {
      const user = auth.currentUser;
      const idToken = await user.getIdToken();
      const res = await fetch("/api/sessions", { headers: { "Authorization": "Bearer " + idToken } });
      const sessions = await res.json();
      const list=document.getElementById("sessions");
      list.innerHTML="";
      if(!Array.isArray(sessions) || !sessions.length){
        list.innerHTML="<p>Nenhuma sessÃ£o encontrada.</p>";
        return;
      }
      sessions.forEach(s=>{
        const div=document.createElement("div");
        div.className="session"+(s.id===selectedSession?" active":"");
        div.textContent="SessÃ£o: "+s.id.substring(0,6);
        div.onclick=()=>selectSession(s.id);
        list.appendChild(div);
      });
    } catch(e){ console.error(e); }
  }

  function selectSession(id){
    selectedSession=id;
    document.getElementById("chat-header").textContent="SessÃ£o: "+id;
    document.getElementById("chat-text").disabled=false;
    document.getElementById("send-btn").disabled=false;
    loadMessages();
  }

  async function loadMessages(){
    if(!selectedSession) return;
    const res=await fetch(`/api/get_messages?sessionId=${selectedSession}`);
    const msgs=await res.json();
    const box=document.getElementById("chat-messages");
    box.innerHTML="";
    msgs.forEach(m=>{
      const div=document.createElement("div");
      div.className="msg "+(m.sender==="user"?"user":"admin");
      div.textContent=m.text;
      box.appendChild(div);
    });
    box.scrollTop=box.scrollHeight;
  }

  async function sendMessage(){
    const text=document.getElementById("chat-text").value.trim();
    if(!text || !selectedSession) return;
    await fetch("/api/send_message",{
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body:JSON.stringify({ sessionId:selectedSession, sender:"admin", text })
    });
    document.getElementById("chat-text").value="";
    loadMessages();
  }
  window.sendMessage = sendMessage;

  // ---- InicializaÃ§Ã£o ----
  onAuthStateChanged(auth, (user) => {
    if (!user) { window.location.href="/login"; return; }
    renderProductsTable();
    setInterval(()=>{ loadSessions(); loadMessages(); },3000);
  });
  window.logout = ()=>signOut(auth);
</script>
</body>
</html>
