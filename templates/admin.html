<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Painel de Controle</title>
  <link rel="manifest" href="/manifest.json">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
  <style>
    body { font-family: 'Poppins', sans-serif; margin:0; display:flex; height:100vh; background:#f4f6f9; }
    .sidebar { width:220px; background:#2c3e50; color:#fff; padding:20px; }
    .sidebar h2 { text-align:center; }
    .sidebar nav a { display:block; padding:10px; margin:5px 0; text-decoration:none; color:#ddd; border-radius:6px; }
    .sidebar nav a.active, .sidebar nav a:hover { background:#34495e; color:#fff; }
    .main { flex:1; padding:20px; overflow-y:auto; }
    h1 { margin:0 0 20px 0; }
    .btn { padding:8px 14px; border:none; border-radius:6px; cursor:pointer; }
    .btn-primary { background:#3498db; color:#fff; }
    .btn-primary:hover { background:#2980b9; }
    table { width:100%; border-collapse:collapse; background:#fff; border-radius:8px; overflow:hidden; }
    th,td { padding:12px; border-bottom:1px solid #eee; text-align:left; }
    th { background:#34495e; color:#fff; }
    img { width:60px; height:40px; object-fit:cover; border-radius:4px; }
    .actions i { cursor:pointer; margin:0 5px; }
    .modal { position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,.6); display:none; align-items:center; justify-content:center; }
    .modal.active { display:flex; }
    .modal-content { background:#fff; padding:20px; border-radius:8px; width:90%; max-width:500px; }
    #toast { position:fixed; bottom:20px; right:20px; background:#333; color:#fff; padding:12px 20px; border-radius:6px; display:none; }
  </style>
</head>
<body>
  <aside class="sidebar">
    <h2>Meu Cat√°logo</h2>
    <nav>
      <a href="#" onclick="showView('produtos')" class="active">üì¶ Produtos</a>
      <a href="#" onclick="showView('clientes')">üë• Clientes</a>
      <a href="/" target="_blank">üëÅ Ver Cat√°logo</a>
      <a href="#" onclick="logout()">üö™ Sair</a>
    </nav>
  </aside>

  <main class="main">
    <div id="view-produtos" class="view active">
      <h1>Gerenciar Produtos</h1>
      <button class="btn btn-primary" onclick="openProductModal()"><i class="fas fa-plus"></i> Novo Produto</button>
      <div id="products-table-container" style="margin-top:20px;"></div>
    </div>
    <div id="view-clientes" class="view" style="display:none;">
      <h1>Clientes</h1>
      <p>Em breve...</p>
    </div>
  </main>

  <div id="product-modal" class="modal">
    <div class="modal-content" id="modal-content"></div>
  </div>

  <div id="toast"></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
import { getMessaging, getToken, onMessage } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-messaging.js";

const firebaseConfig = {
  apiKey: "AIzaSyB-rnG4cIZzEb1w_h_qmif3XPSx28ZIdaM",
  authDomain: "ecomercie-vendas.firebaseapp.com",
  projectId: "ecomercie-vendas",
  storageBucket: "ecomercie-vendas.firebasestorage.app",
  messagingSenderId: "1054540261609",
  appId: "1:1054540261609:web:90042b823220b4c73f6878"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const messaging = getMessaging(app);

// --- Notifica√ß√µes push ---
async function registerFcmToken() {
  try {
    const user = auth.currentUser;
    if (!user) return;
    if (Notification.permission !== "granted") await Notification.requestPermission();
    const token = await getToken(messaging, { vapidKey: "BNZLoKzBHSC6kWGUpglcgyo1_xkmS_zmO2ux_VDBEvn5Qai3NJeZfN2u612WVEvMyEao0e1V3rPeReBZVV2nNJg" });
    if (token) {
      const idToken = await user.getIdToken();
      await fetch("/api/save_fcm_token", {
        method:"POST",
        headers:{ "Content-Type":"application/json","Authorization":"Bearer "+idToken },
        body:JSON.stringify({token})
      });
      console.log("Token salvo no servidor!");
    }
  } catch(e){ console.error("Erro FCM:", e); }
}

onMessage(messaging, (payload)=>{
  console.log("Mensagem no admin:", payload);
  showToast(payload.notification?.title+" - "+payload.notification?.body);
});

function showToast(msg){
  const toast=document.getElementById("toast");
  toast.innerText=msg;
  toast.style.display="block";
  setTimeout(()=>toast.style.display="none",4000);
}

// --- Views ---
window.showView = function(view) {
  document.querySelectorAll(".view").forEach(v=>v.style.display="none");
  document.getElementById("view-"+view).style.display="block";
  document.querySelectorAll(".sidebar nav a").forEach(a=>a.classList.remove("active"));
}

// --- Modal Produto ---
window.openProductModal = function(product=null) {
  const modal=document.getElementById("product-modal");
  const mc=document.getElementById("modal-content");
  mc.innerHTML=`
    <h2>${product?"Editar":"Novo"} Produto</h2>
    <label>Nome:</label><input type="text" id="productName" value="${product?.nome||""}">
    <label>Pre√ßo (R$):</label><input type="number" id="productPrice" value="${product?.valor||0}">
    <div style="margin-top:15px;">
      <button class="btn" onclick="closeModal()">Cancelar</button>
      <button class="btn btn-primary" onclick="saveProduct('${product?.id||""}')">Salvar</button>
    </div>`;
  modal.classList.add("active");
}

window.closeModal = function(){ document.getElementById("product-modal").classList.remove("active"); }

// --- Salvar produto ---
window.saveProduct = async function(id="") {
  const user=auth.currentUser; if(!user) return;
  const idToken=await user.getIdToken();
  const data={nome:document.getElementById("productName").value, valor:parseFloat(document.getElementById("productPrice").value)};
  const url=id?`/api/products/${id}`:"/api/products";
  const method=id?"PUT":"POST";
  await fetch(url,{method,headers:{"Content-Type":"application/json","Authorization":"Bearer "+idToken},body:JSON.stringify(data)});
  closeModal(); renderProductsTable();
}

// --- Renderizar tabela ---
async function renderProductsTable() {
  const user=auth.currentUser; if(!user) return;
  const idToken=await user.getIdToken();
  const res=await fetch("/api/my_products",{headers:{"Authorization":"Bearer "+idToken}});
  const produtos=await res.json();
  let html="<table><tr><th>Nome</th><th>Pre√ßo</th><th>A√ß√µes</th></tr>";
  produtos.forEach(p=>{
    html+=`<tr><td>${p.nome}</td><td>R$ ${(p.valor||0).toFixed(2)}</td>
    <td><i class="fas fa-edit" onclick='openProductModal(${JSON.stringify(p)})'></i>
    <i class="fas fa-trash" onclick='deleteProduct("${p.id}")'></i></td></tr>`;
  });
  html+="</table>";
  document.getElementById("products-table-container").innerHTML=html;
}

window.deleteProduct = async function(id){
  const user=auth.currentUser; if(!user) return;
  const idToken=await user.getIdToken();
  await fetch(`/api/products/${id}`,{method:"DELETE",headers:{"Authorization":"Bearer "+idToken}});
  renderProductsTable();
}

// --- Auth ---
onAuthStateChanged(auth,(user)=>{ if(!user){window.location="/login"} else { renderProductsTable(); registerFcmToken(); } });
window.logout=()=>signOut(auth);
</script>
</body>
</html>
