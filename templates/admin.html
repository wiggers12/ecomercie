<script src="https://cdn.onesignal.com/sdks/OneSignalSDK.js" async></script>
<script>
  // ==== UI helpers ====
  function toast(msg){const t=document.getElementById('toast');t.textContent=msg;t.style.display='block';clearTimeout(window.__t);window.__t=setTimeout(()=>t.style.display='none',3200);}
  function setBadge(on){const b=document.getElementById('status-badge');b.textContent=on?'Push ativo':'Push desativado';b.className='badge ' + (on?'ok':'off');}
  function setDiag(id,val){const el=document.getElementById(id); if(el) el.textContent=val;}

  const isiOS = /iPhone|iPad|iPod/i.test(navigator.userAgent);
  const isStandalone = ('standalone' in navigator) && navigator.standalone;
  setDiag('d_pwa', isStandalone ? 'sim' : 'n√£o');

  // Bot√£o extra (opcional): re-instalar SW para limpar cache teimoso no iOS
  // Adicione um bot√£o no HTML se quiser: <button class="ghost" onclick="reinstalarSW()">Reinstalar SW</button>
  async function reinstalarSW(){
    if ('serviceWorker' in navigator) {
      const regs = await navigator.serviceWorker.getRegistrations();
      for (const r of regs) { try { await r.unregister(); } catch(e){} }
      toast('SW removido. Recarregando‚Ä¶'); setTimeout(()=>location.reload(), 600);
    } else {
      toast('Este navegador n√£o tem serviceWorker.');
    }
  }
  window.reinstalarSW = reinstalarSW;

  // ==== Fluxo de ativa√ß√£o robusto (iOS PWA amig√°vel) ====
  async function ativarPush(){
    setDiag('d_last','clicou: Ativar notifica√ß√µes');

    // iOS exige PWA
    if (isiOS && !isStandalone) {
      toast('üì≤ No iPhone, instale como app: Compartilhar ‚Üí Adicionar √† Tela de In√≠cio.');
      return;
    }

    // SDK carregado?
    if (!window.OneSignal){ toast('‚åõ SDK ainda carregando‚Ä¶'); return; }

    // Suporte real do navegador (importante no iOS)
    try {
      const supported = await OneSignal.isPushNotificationsSupported();
      setDiag('d_sdk', 'sim'); // SDK ok
      if (!supported) {
        setDiag('d_enabled','n√£o'); 
        toast('‚ùå Este ambiente n√£o suporta Web Push.');
        return;
      }
    } catch {
      // segue o fluxo mesmo assim
    }

    try {
      const already = await OneSignal.isPushNotificationsEnabled();
      if (already){
        try { await OneSignal.sendTag('role','admin'); } catch(e){ console.log(e); }
        setBadge(true); setDiag('d_enabled','sim'); toast('‚úÖ J√° est√° ativado (marcado como ADMIN).');
        return;
      }

      // 1) Pe√ßa permiss√£o nativa (recomendado em iOS PWA / SDK novo)
      if (OneSignal.Notifications?.requestPermission) {
        await OneSignal.Notifications.requestPermission();
      }

      // 2) For√ßa a inscri√ß√£o (SDK novo)
      if (OneSignal.User?.PushSubscription?.optIn) {
        try { await OneSignal.User.PushSubscription.optIn(); } catch(e){ console.log('optIn falhou:', e); }
      }

      // 3) Fallback pro slidedown (SDK antigo)
      if (OneSignal.Slidedown?.promptPush) {
        await OneSignal.Slidedown.promptPush();
      } else if (OneSignal.showSlidedownPrompt) {
        await OneSignal.showSlidedownPrompt();
      }

      // Checa estado final
      const enabledNow = await OneSignal.isPushNotificationsEnabled();
      setBadge(enabledNow); setDiag('d_enabled', enabledNow ? 'sim' : 'n√£o');
      if (enabledNow) {
        try { await OneSignal.sendTag('role','admin'); toast('‚úÖ Ativado e marcado como ADMIN.'); }
        catch(e){ console.log(e); toast('‚ö†Ô∏è Ativado, mas falhou ao aplicar a tag.'); }
      } else {
        toast('‚ö†Ô∏è Permiss√£o n√£o conclu√≠da. Verifique Ajustes ‚Üí Notifica√ß√µes ‚Üí Ecomercie Admin.');
      }
    } catch(e){
      console.log(e);
      toast('‚ùå Erro ao solicitar permiss√£o.');
    }
  }
  window.ativarPush = ativarPush;

  async function testarPush(){
    setDiag('d_last','clicou: Testar push');
    try {
      const r = await fetch('/test-notify', { cache: 'no-store' });
      const j = await r.json();
      toast(j.sent ? 'üì® Push de teste enviado!' : '‚ùå Falha ao enviar push.');
    } catch { toast('‚ùå Erro ao chamar o servidor.'); }
  }
  window.testarPush = testarPush;

  // ==== Inicializa√ß√£o ====
  window.OneSignal = window.OneSignal || [];
  OneSignal.push(async function () {
    setDiag('d_sdk','sim');

    OneSignal.init({
      appId: "2525d779-4ba0-490c-9ac7-b117167053f7",
      notifyButton: { enable: true, position: "bottom-right", prenotify: true, showCredit: false }
    });

    // Mostra se h√° suporte real
    try {
      const supported = await OneSignal.isPushNotificationsSupported();
      if (!supported) toast('‚ö†Ô∏è Este navegador n√£o suporta Web Push.');
    } catch {}

    // Estado inicial + garante TAG para inscritos antigos
    try {
      const enabled = await OneSignal.isPushNotificationsEnabled();
      setBadge(enabled);
      setDiag('d_enabled', enabled ? 'sim' : 'n√£o');
      document.getElementById('info').textContent = enabled
        ? 'Este dispositivo j√° est√° inscrito para receber push.'
        : 'Clique em "Ativar notifica√ß√µes" para se inscrever.';
      if (enabled) { try { await OneSignal.sendTag('role','admin'); } catch(e){} }
    } catch {}

    // Reage a mudan√ßas de inscri√ß√£o
    OneSignal.on('subscriptionChange', async (ok) => {
      setBadge(ok); setDiag('d_enabled', ok ? 'sim' : 'n√£o');
      if (ok) {
        try { await OneSignal.sendTag('role','admin'); toast('‚úÖ Ativado e marcado como ADMIN.'); }
        catch(e){ console.log(e); toast('‚ö†Ô∏è Ativado, mas falhou ao aplicar a tag.'); }
      } else {
        toast('üîï Notifica√ß√µes desativadas.');
      }
    });
  });
</script>
