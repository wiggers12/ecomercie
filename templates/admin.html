<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Painel Admin</title>
  <link rel="manifest" href="/manifest.json" />
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">

  <!-- OneSignal -->
  <script src="https://cdn.onesignal.com/sdks/web/v16/OneSignalSDK.page.js" defer></script>
  <script>
    window.OneSignalDeferred = window.OneSignalDeferred || [];
    OneSignalDeferred.push(async function(OneSignal) {
      await OneSignal.init({
        appId: "2525d779-4ba0-490c-9ac7-b117167053f7", // Seu App ID do OneSignal
        notifyButton: { enable: false } // bot√£o padr√£o desativado, usamos o customizado
      });

      // Checa o estado da permiss√£o (SDK v16)
  const permission = OneSignal.Notifications.permission;
      console.log("üîç Estado da permiss√£o:", permission);

      if (permission === "denied") {
        alert("‚ö†Ô∏è Permiss√£o negada para notifica√ß√µes. V√° em Ajustes > Navegador > Notifica√ß√µes e habilite manualmente.");
      }
    });

    async function ativarNotificacoes() {
  const OneSignal = window.OneSignal;
  try {
    // Pede a permiss√£o ao usu√°rio
    const permission = await OneSignal.Notifications.requestPermission();
    
    console.log("üîî Resultado da permiss√£o:", permission);

    if (permission === "granted") {
      // Caso 1: Usu√°rio PERMITIU
      alert("‚úÖ Notifica√ß√µes ativadas com sucesso!");

    } else if (permission === "denied") {
      // Caso 2: Usu√°rio BLOQUEOU
      alert("‚ö†Ô∏è Voc√™ bloqueou as notifica√ß√µes. Para ativ√°-las, ser√° preciso ir nas configura√ß√µes do navegador.");

    } else {
      // Caso 3: Usu√°rio FECHOU A CAIXA (estado 'default')
      alert("‚ÑπÔ∏è A permiss√£o n√£o foi concedida. Tente novamente quando quiser receber notifica√ß√µes.");
    }

  } catch (e) {
    console.error("Erro ao pedir permiss√£o:", e);
    alert("‚ùå Erro ao tentar ativar notifica√ß√µes.");
  }
}
  </script>

  <style>
    body { margin:0; font-family:Poppins,sans-serif; background:#f4f4f4; }
    .header { background:#2c3e50; color:#fff; padding:20px; display:flex; justify-content:space-between; align-items:center; }
    h1 { margin:0; }
    .btn { padding:10px 15px; border:none; border-radius:6px; cursor:pointer; font-weight:600; margin-right:10px; }
    .btn-primary { background:#3498db; color:#fff; }
    .btn-success { background:#198754; color:#fff; }
    .btn-danger { background:#e74c3c; color:#fff; }
    .table { width:100%; margin-top:20px; border-collapse:collapse; background:#fff; }
    .table th,.table td { padding:12px; border:1px solid #ddd; text-align:left; }
    .toast-container { position:fixed; bottom:20px; right:20px; z-index:9999; }
    .toast { background:#2c3e50; color:#fff; padding:15px; border-radius:6px; margin-top:10px; }
    .modal { position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.6);display:flex;align-items:center;justify-content:center;z-index:999; }
    .modal-content { background:#fff;padding:20px;border-radius:8px;width:400px;max-width:95%; }
    .modal-content label { display:block;margin-top:10px;font-weight:500; }
    .progress-bar { width:0%;height:5px;background:green;margin-top:5px; }
  </style>
</head>
<body>
  <div class="header">
    <h1>Painel Admin</h1>
    <div>
      <button class="btn btn-success" onclick="ativarNotificacoes()">üîî Ativar Notifica√ß√µes</button>
      <button class="btn btn-primary" onclick="openProductModal()">+ Novo Produto</button>
      <button class="btn btn-danger" onclick="logout()">Sair</button>
    </div>
  </div>

  <div id="products-table-container"></div>
  <div id="toast-container" class="toast-container"></div>

<!-- Firebase Messaging -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import { 
    getAuth, onAuthStateChanged, signOut 
  } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
  import { getFirestore } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
  import { 
    getStorage, ref, uploadBytesResumable, getDownloadURL 
  } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js";
  import { getMessaging, getToken, onMessage } 
    from "https://www.gstatic.com/firebasejs/10.12.2/firebase-messaging.js";

  const firebaseConfig = {
    apiKey: "AIzaSyB-rnG4cIZzEb1w_h_qmif3XPSx28ZIdaM",
    authDomain: "ecomercie-vendas.firebaseapp.com",
    projectId: "ecomercie-vendas",
    storageBucket: "ecomercie-vendas.firebasestorage.app",
    messagingSenderId: "1054540261609",
    appId: "1:1054540261609:web:90042b823220b4c73f6878",
    measurementId: "G-TNC5M9G89H"
  };

  // Inicializa Firebase
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);
  const storage = getStorage(app);
  const messaging = getMessaging(app);

  // --- Notifica√ß√µes FCM ---
  async function gerarToken() {
    try {
      const token = await getToken(messaging, {
        vapidKey: "BNZLoKzBHSC6kWGUpglcgyo1_xkmS_zmO2ux_VDBEvn5Qai3NJeZfN2u612WVEvMyEao0e1V3rPeReBZVV2nNJg" // üîë pega no Firebase Console > Cloud Messaging
      });
      if (token) {
        console.log("üî• Token FCM:", token);
      } else {
        console.warn("‚ö†Ô∏è Usu√°rio n√£o deu permiss√£o para notifica√ß√µes.");
      }
    } catch (err) {
      console.error("‚ùå Erro ao gerar token:", err);
    }
  }

  onMessage(messaging, (payload) => {
    console.log("üì© Notifica√ß√£o recebida:", payload);
    alert(`üîî ${payload.notification?.title}\n${payload.notification?.body}`);
  });

  gerarToken();

  // agora `auth`, `onAuthStateChanged`, `signOut`, `storage`, `ref`, etc. 
  // j√° est√£o dispon√≠veis e v√£o funcionar no restante do c√≥digo.
</script>

  

    // --- Toast helper
    function showToast(msg) {
      const container = document.getElementById("toast-container");
      const toast = document.createElement("div");
      toast.className = "toast";
      toast.innerText = msg;
      container.appendChild(toast);
      setTimeout(() => toast.remove(), 5000);
    }

    // --- Render tabela produtos
    async function renderProductsTable() {
      const user = auth.currentUser;
      if (!user) return;
      const idToken = await user.getIdToken();
      const res = await fetch("/api/my_products", { headers: { "Authorization": "Bearer " + idToken } });
      const products = await res.json();
      if (!products.length) {
        document.getElementById("products-table-container").innerHTML = "<p>Nenhum produto ainda.</p>";
        return;
      }
      let html = `<table class="table"><tr><th>Nome</th><th>Pre√ßo</th><th>Imagem</th><th>V√≠deo</th></tr>`;
      products.forEach(p => { 
        html += `<tr>
          <td>${p.nome}</td>
          <td>R$ ${(p.valor||0).toFixed(2)}</td>
          <td>${p.imagemUrl ? `<img src="${p.imagemUrl}" width="60">` : "-"}</td>
          <td>${p.videoUrl ? `<a href="${p.videoUrl}" target="_blank">Ver</a>` : "-"}</td>
        </tr>`;
      });
      html += `</table>`;
      document.getElementById("products-table-container").innerHTML = html;
    }

    // --- Modal Produto + Upload
    window.openProductModal = () => {
      const modal = document.createElement("div");
      modal.className = "modal";
      modal.innerHTML = `
        <div class="modal-content">
          <h3>Novo Produto</h3>
          <label>Nome:</label><input id="nomeProd">
          <label>Pre√ßo:</label><input id="valorProd" type="number" step="0.01">
          <label>Imagem:</label><input id="imgProd" type="file" accept="image/*">
          <div id="img-progress" class="progress-bar"></div>
          <label>V√≠deo:</label><input id="videoProd" type="file" accept="video/*">
          <div id="vid-progress" class="progress-bar"></div>
          <button class="btn btn-primary" onclick="saveProduct()">Salvar</button>
          <button class="btn btn-danger" onclick="this.closest('.modal').remove()">Cancelar</button>
        </div>`;
      document.body.appendChild(modal);
    };

    async function uploadFile(file, progressId) {
      return new Promise((resolve, reject) => {
        const storageRef = ref(storage, `uploads/${Date.now()}_${file.name}`);
        const task = uploadBytesResumable(storageRef, file);
        task.on("state_changed", snap => {
          const pct = (snap.bytesTransferred / snap.totalBytes) * 100;
          document.getElementById(progressId).style.width = pct + "%";
        }, reject, async () => {
          const url = await getDownloadURL(task.snapshot.ref);
          resolve(url);
        });
      });
    }

    window.saveProduct = async () => {
      const user = auth.currentUser;
      const idToken = await user.getIdToken();
      let imgUrl="", vidUrl="";
      const imgFile=document.getElementById("imgProd").files[0];
      const vidFile=document.getElementById("videoProd").files[0];
      if (imgFile) imgUrl = await uploadFile(imgFile,"img-progress");
      if (vidFile) vidUrl = await uploadFile(vidFile,"vid-progress");
      const produto={ 
        nome:document.getElementById("nomeProd").value, 
        valor:parseFloat(document.getElementById("valorProd").value)||0, 
        imagemUrl:imgUrl, 
        videoUrl:vidUrl 
      };
      await fetch("/api/products",{
        method:"POST", 
        headers:{"Content-Type":"application/json","Authorization":"Bearer "+idToken},
        body:JSON.stringify(produto)
      });
      document.querySelector(".modal").remove();
      renderProductsTable();
      showToast("‚úÖ Produto adicionado com sucesso!");
    };

    // --- Auth
    onAuthStateChanged(auth, (user) => {
      if (!user) { window.location.href="/login"; return; }
      renderProductsTable();
    });
    window.logout = ()=>signOut(auth);
  </script>
</body>
</html>
