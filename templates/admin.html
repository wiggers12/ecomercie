<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ecomercie — Admin</title>

  <!-- PWA -->
  <link rel="manifest" href="/static/manifest.json" />
  <meta name="theme-color" content="#0b1220" />
  <link rel="icon" href="/static/icon-192.png" type="image/png" />
  <link rel="apple-touch-icon" href="/static/icon-512.png" />

  <style>
    :root { --bg:#0b1220; --fg:#e8eefc; --accent:#2ecc71; --warn:#ffb020; --err:#ff5a5f; }
    body { margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; background:#f6f7fb; color:#1f2430;}
    header { background:var(--bg); color:var(--fg); padding:18px 20px; display:flex; align-items:center; justify-content:space-between; }
    header h1 { font-size:18px; margin:0; }
    main { max-width:920px; margin:26px auto; padding:0 16px; }
    .card { background:#fff; border-radius:12px; box-shadow:0 8px 24px rgba(15,23,42,.06); padding:18px; margin-bottom:16px; }
    .row { display:flex; gap:12px; flex-wrap:wrap; align-items:center; }
    button, .button-link { border:0; border-radius:10px; padding:12px 16px; cursor:pointer; font-weight:600; font-family:inherit; font-size:14px; }
    .primary { background:#2c7be5; color:#fff; }
    .ghost { background:#eef3ff; color:#1f2430; }
    .danger { background:#ffeaea; color:#b42318; }
    .badge { display:inline-block; padding:6px 10px; border-radius:999px; font-size:12px; font-weight:700; }
    .ok { background:#e7f9ef; color:#0e8a4b; }
    .off { background:#ffe8e8; color:#b42318; }
    .muted { color:#667085; font-size:14px; }
    .toast { position:fixed; left:50%; transform:translateX(-50%); bottom:22px; background:#111827; color:#fff; padding:12px 16px; border-radius:10px; box-shadow:0 8px 24px rgba(0,0,0,.25); display:none; z-index:9999; }
    .diag { font-size:13px; background:#f8fafc; border-radius:10px; padding:10px; }
    code { background:#eef2f7; padding:1px 6px; border-radius:6px; }
    a.primary, a.ghost, a.danger { text-decoration:none; }

    /* Produtos */
    #product-list .product-item { display:flex; align-items:center; padding:12px 0; border-bottom:1px solid #f0f2f5; }
    #product-list .product-item:last-child { border-bottom:none; }
    .product-item img { width:50px; height:50px; border-radius:8px; object-fit:cover; margin-right:15px; }
    .product-item .info { flex-grow:1; }
    .product-item .info h4 { margin:0; font-size:15px; }
    .product-item .info p { margin:0; color:#667085; font-size:14px; }
    .product-item .actions { display:flex; gap:8px; }

    .modal-overlay { position:fixed; inset:0; background:rgba(17,24,39,.6); z-index:2000; display:none; justify-content:center; align-items:center; backdrop-filter:blur(4px); }
    .modal-content { background:#fff; padding:24px; border-radius:12px; max-width:500px; width:90%; max-height:90vh; overflow-y:auto; }
    .modal-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; }
    .modal-header h3 { margin:0; }
    .form-group { margin-bottom:16px; }
    .form-group label { display:block; font-weight:600; margin-bottom:6px; font-size:14px; }
    .form-group input, .form-group textarea { width:100%; padding:10px 12px; border:1px solid #d0d5dd; border-radius:8px; font-family:inherit; font-size:14px; }
    .form-group textarea { resize:vertical; min-height:80px; }
    .upload-area { border:2px dashed #d0d5dd; border-radius:8px; padding:20px; text-align:center; cursor:pointer; }
    .upload-area input { display:none; }
    .modal-footer { display:flex; justify-content:flex-end; gap:12px; margin-top:24px; }
  </style>
</head>
<body>
  <header>
    <h1>Ecomercie — Painel do Admin</h1>
    <span id="status-badge" class="badge off">Push desativado</span>
  </header>

  <main>
    <!-- Produtos -->
    <section class="card">
      <div class="row" style="justify-content:space-between;">
        <h3>Gerenciamento de Produtos</h3>
        <button class="primary" onclick="openModal()">+ Adicionar Produto</button>
      </div>
      <div id="product-list" style="margin-top:16px;"></div>
    </section>

    <!-- Push -->
    <section class="card">
      <h3>Notificações</h3>
      <p class="muted">
        Ative para receber alertas quando o catálogo for acessado. Após a inscrição, este dispositivo recebe a tag
        <code>role=admin</code>.
      </p>
      <div class="row" style="margin-top:10px">
        <button class="primary" onclick="ativarPush()">Ativar notificações</button>
        <button class="ghost"   onclick="testarPush()">Testar push (servidor)</button>
        <button class="ghost"   onclick="fixarAdmin()">Fixar como admin</button>
        <button class="danger"  onclick="resetarPush()">Resetar push</button>
      </div>
      <div class="diag" style="margin-top:12px">
        <div>SDK carregado: <b id="d_sdk">não</b></div>
        <div>Suporte a Web Push: <b id="d_support">desconhecido</b></div>
        <div>Permissão do navegador: <b id="d_perm">desconhecida</b></div>
        <div>Modo PWA (standalone): <b id="d_pwa">não</b></div>
        <div>Push habilitado: <b id="d_enabled">desconhecido</b></div>
        <div>Subscription ID: <code id="d_sid">—</code></div>
        <div>Última ação: <b id="d_last">—</b></div>
      </div>
      <p id="info" class="muted" style="margin-top:8px"></p>
    </section>

    <section class="card">
      <h3>Ferramentas Externas</h3>
      <p class="muted">Acesse outras plataformas importantes para o gerenciamento da loja.</p>
      <div class="row" style="margin-top:10px">
        <a href="https://dashboard.tawk.to/" target="_blank" class="primary">Acessar Chat (Tawk.to)</a>
      </div>
    </section>

    <section class="card">
      <h3>Dicas rápidas</h3>
      <ul class="muted">
        <li><b>iPhone</b>: instale como app (Compartilhar → <b>Adicionar à Tela de Início</b>) e ative o push <b>dentro do app instalado</b>.</li>
        <li>Se negou a permissão: Ajustes → Notificações → <i>Ecomercie Admin</i> → Permitir.</li>
      </ul>
    </section>
  </main>

  <div id="toast" class="toast"></div>

  <!-- Modal de produto -->
  <div class="modal-overlay" id="product-modal">
    <div class="modal-content">
      <div class="modal-header"><h3 id="modal-title">Adicionar Novo Produto</h3></div>
      <form id="product-form">
        <input type="hidden" id="product-id">
        <div class="form-group">
          <label for="product-name">Nome do Produto</label>
          <input type="text" id="product-name" required>
        </div>
        <div class="form-group">
          <label for="product-price">Preço (ex.: 29.99)</label>
          <input type="number" step="0.01" id="product-price" required>
        </div>
        <div class="form-group">
          <label for="product-description">Descrição</label>
          <textarea id="product-description"></textarea>
        </div>
        <div class="form-group">
          <label>Imagens</label>
          <label for="product-images" class="upload-area"><span id="image-upload-text">Clique ou arraste para enviar</span></label>
          <input type="file" id="product-images" accept="image/*" multiple>
        </div>
        <div class="form-group">
          <label>Vídeo (Opcional)</label>
          <label for="product-video" class="upload-area"><span id="video-upload-text">Clique ou arraste para enviar</span></label>
          <input type="file" id="product-video" accept="video/*">
        </div>
        <div class="modal-footer">
          <button type="button" class="ghost" onclick="closeModal()">Cancelar</button>
          <button type="submit" class="primary">Salvar Produto</button>
        </div>
      </form>
    </div>
  </div>

  <!-- OneSignal SDK -->
  <script src="https://cdn.onesignal.com/sdks/OneSignalSDK.js" async></script>

  <script>
    /* ========= util UI ========= */
    function toast(msg){ const t=document.getElementById('toast'); t.textContent=msg; t.style.display='block'; clearTimeout(window.__t); window.__t=setTimeout(()=>t.style.display='none',3200); }
    function setBadge(on){ const b=document.getElementById('status-badge'); b.textContent=on?'Push ativo':'Push desativado'; b.className='badge ' + (on?'ok':'off'); }
    function setDiag(id,val){ const el=document.getElementById(id); if(el) el.textContent = (val ?? '').toString(); }
    const isiOS = /iPhone|iPad|iPod/i.test(navigator.userAgent);
    const isStandalone = ('standalone' in navigator) && navigator.standalone;
    setDiag('d_pwa', isStandalone ? 'sim' : 'não');
    setDiag('d_perm', (typeof Notification!=='undefined' ? Notification.permission : 'n/a'));

    /* ========= Produtos (mock) ========= */
    const productModal = document.getElementById('product-modal');
    const productForm = document.getElementById('product-form');
    const productList = document.getElementById('product-list');
    let products = [
      { id: 1, name: 'Smartphone Pro', price: 2999.90, description: 'Ótimo celular.', image: 'https://via.placeholder.com/50' },
      { id: 2, name: 'Fone Bluetooth', price: 399.00, description: 'Som de alta qualidade.', image: 'https://via.placeholder.com/50' },
    ];
    function renderProducts(){
      productList.innerHTML = products.length ? '' : '<p class="muted">Nenhum produto cadastrado ainda.</p>';
      products.forEach(p=>{
        const el = document.createElement('div');
        el.className='product-item';
        el.innerHTML = `
          <img src="${p.image}" alt="${p.name}">
          <div class="info"><h4>${p.name}</h4><p>R$ ${p.price.toFixed(2).replace('.', ',')}</p></div>
          <div class="actions">
            <button class="ghost" onclick="openModal(${p.id})">Editar</button>
            <button class="danger" onclick="deleteProduct(${p.id})">Excluir</button>
          </div>`;
        productList.appendChild(el);
      });
    }
    function openModal(id=null){
      productForm.reset();
      document.getElementById('image-upload-text').textContent = 'Clique ou arraste para enviar';
      document.getElementById('video-upload-text').textContent = 'Clique ou arraste para enviar';
      if(id){
        const p = products.find(x=>x.id===id);
        document.getElementById('modal-title').textContent='Editar Produto';
        document.getElementById('product-id').value=p.id;
        document.getElementById('product-name').value=p.name;
        document.getElementById('product-price').value=p.price;
        document.getElementById('product-description').value=p.description;
      }else{
        document.getElementById('modal-title').textContent='Adicionar Novo Produto';
        document.getElementById('product-id').value='';
      }
      productModal.style.display='flex';
    }
    function closeModal(){ productModal.style.display='none'; }
    function deleteProduct(id){
      if(confirm('Tem certeza que deseja excluir este produto?')){
        products = products.filter(p=>p.id!==id);
        renderProducts();
        toast('Produto excluído com sucesso.');
      }
    }
    productForm.addEventListener('submit', (e)=>{
      e.preventDefault();
      const id = document.getElementById('product-id').value;
      const data = {
        name: document.getElementById('product-name').value,
        price: parseFloat(document.getElementById('product-price').value),
        description: document.getElementById('product-description').value,
        image: 'https://via.placeholder.com/50'
      };
      if(id){
        const i = products.findIndex(p=>p.id==id);
        products[i] = { ...products[i], ...data };
        toast('Produto atualizado com sucesso.');
      }else{
        data.id = Date.now();
        products.push(data);
        toast('Produto adicionado com sucesso.');
      }
      renderProducts();
      closeModal();
    });
    document.getElementById('product-images').addEventListener('change', (e)=>{
      document.getElementById('image-upload-text').textContent = e.target.files.length ? `${e.target.files.length} imagem(ns)` : 'Clique ou arraste para enviar';
    });
    document.getElementById('product-video').addEventListener('change', (e)=>{
      document.getElementById('video-upload-text').textContent = e.target.files.length ? e.target.files[0].name : 'Clique ou arraste para enviar';
    });
    document.addEventListener('DOMContentLoaded', renderProducts);
    window.openModal=openModal; window.closeModal=closeModal; window.deleteProduct=deleteProduct;

    /* ========= OneSignal ========= */
    async function getSubscriptionId(){
      try{
        // SDK novo
        const id = await OneSignal?.User?.PushSubscription?.id;
        if(id) return id;
      }catch(_){}
      try{
        // Fallback (algumas builds ainda expõem)
        if (OneSignal.getUserId) return await OneSignal.getUserId();
      }catch(_){}
      return null;
    }
    async function atualizarDiagEstado(){
      try{
        const supported = await OneSignal.isPushNotificationsSupported?.();
        setDiag('d_support', supported === false ? 'não' : 'sim');
      }catch{ setDiag('d_support','sim'); }
      setDiag('d_perm', (typeof Notification!=='undefined' ? Notification.permission : 'n/a'));
      try{
        const enabled = await OneSignal.isPushNotificationsEnabled();
        setBadge(enabled);
        setDiag('d_enabled', enabled ? 'sim':'não');
      }catch{ setBadge(false); setDiag('d_enabled','não'); }
      try{
        const sid = await getSubscriptionId();
        setDiag('d_sid', sid || '—');
      }catch{ setDiag('d_sid','—'); }
    }
    function instrucoesDesbloqueio(){
      if(isiOS){
        return isStandalone
          ? 'Ajustes → Notificações → Ecomercie Admin → Permitir.'
          : 'Instale como app (Compartilhar → Adicionar à Tela de Início) e abra o app.';
      }
      return 'Verifique Permissões do site (cadeado ao lado do endereço) e permita Notificações.';
    }

    async function ativarPush(){
      setDiag('d_last','clicou: Ativar notificações');
      if (isiOS && !isStandalone){ toast('📲 No iPhone, instale como app (Tela de Início).'); return; }
      if (!window.OneSignal){ toast('⌛ SDK ainda carregando…'); return; }
      if (typeof Notification!=='undefined' && Notification.permission==='denied'){ toast('⚠️ Permissão bloqueada. ' + instrucoesDesbloqueio()); return; }

      try{
        const supported = await OneSignal.isPushNotificationsSupported?.();
        if (supported === false){ toast('❌ Este ambiente não suporta Web Push.'); return; }

        // já está?
        if (await OneSignal.isPushNotificationsEnabled()){
          try{ await OneSignal.sendTag('role','admin'); }catch(_){}
          toast('✅ Já está ativado (ADMIN).');
          await atualizarDiagEstado();
          return;
        }

        // iOS exige: solicitar permissão + opt-in explícito
        if (OneSignal.Notifications?.requestPermission){
          const r = await OneSignal.Notifications.requestPermission(); // granted/denied/default
          setDiag('d_perm', r);
          if (r==='denied'){ toast('⚠️ Permissão negada. ' + instrucoesDesbloqueio()); return; }
        }
        if (OneSignal.User?.PushSubscription?.optIn){
          try{ await OneSignal.User.PushSubscription.optIn(); }catch(_){}
        }

        // fallback de prompt
        if (OneSignal.Slidedown?.promptPush) { await OneSignal.Slidedown.promptPush(); }
        else if (OneSignal.showSlidedownPrompt) { await OneSignal.showSlidedownPrompt(); }

        const enabledNow = await OneSignal.isPushNotificationsEnabled();
        setBadge(enabledNow);
        setDiag('d_enabled', enabledNow ? 'sim':'não');

        if (enabledNow){
          try{ await OneSignal.sendTag('role','admin'); }catch(_){}
          const sid = await getSubscriptionId();
          setDiag('d_sid', sid || '—');
          toast('✅ Ativado e marcado como ADMIN.');
        }else{
          if (typeof Notification!=='undefined' && Notification.permission==='default'){
            toast('⚠️ Confirme o pedido de permissão do sistema.');
          }else{
            toast('⚠️ Permissão não concluída. ' + instrucoesDesbloqueio());
          }
        }
      }catch(e){
        console.log(e);
        toast('❌ Erro ao solicitar permissão.');
      }
      await atualizarDiagEstado();
    }
    async function fixarAdmin(){
      setDiag('d_last','clicou: Fixar como admin');
      if (!window.OneSignal){ toast('SDK ainda carregando…'); return; }
      try{ await OneSignal.sendTag('role','admin'); toast('🏷️ Tag role=admin aplicada.'); }
      catch{ toast('⚠️ Falhou ao aplicar tag.'); }
    }
    async function testarPush(){
      setDiag('d_last','clicou: Testar push');
      try{
        const r = await fetch('/test-notify', { cache:'no-store' });
        const j = await r.json();
        const ok = j.ok === true || j.sent === true;
        toast(ok ? '📨 Push (admins) enviado!' : '❌ Falha no envio.');
        console.log('test-notify →', j);
      }catch{
        toast('❌ Erro ao chamar o servidor.');
      }
    }
    async function resetarPush(){
      setDiag('d_last','clicou: Resetar push');
      try{
        // 1) desinscrever no OneSignal
        if (OneSignal?.User?.PushSubscription?.optOut) {
          try{ await OneSignal.User.PushSubscription.optOut(); }catch(_){}
        }
        // 2) remover SWs
        if ('serviceWorker' in navigator){
          const regs = await navigator.serviceWorker.getRegistrations();
          for (const r of regs){ try{ await r.unregister(); }catch(_){ } }
        }
        // 3) limpar diagnósticos
        setBadge(false); setDiag('d_enabled','não'); setDiag('d_sid','—');
        toast('🔄 SW removido / inscrição limpa. Reabra e ative novamente.');
        setTimeout(()=>location.reload(), 700);
      }catch{
        toast('⚠️ Não foi possível resetar.');
      }
    }
    window.ativarPush=ativarPush; window.fixarAdmin=fixarAdmin; window.testarPush=testarPush; window.resetarPush=resetarPush;

    // Inicialização OneSignal
    window.OneSignal = window.OneSignal || [];
    OneSignal.push(async () => {
      setDiag('d_sdk','sim');
      OneSignal.init({
        appId: "2525d779-4ba0-490c-9ac7-b117167053f7",
        notifyButton: { enable:true, position:"bottom-right", prenotify:true, showCredit:false }
      });
      await atualizarDiagEstado();
      OneSignal.on('subscriptionChange', async (ok)=>{
        setBadge(ok); setDiag('d_enabled', ok?'sim':'não');
        if (ok){
          try{ await OneSignal.sendTag('role','admin'); toast('✅ Ativado e marcado como ADMIN.'); }
          catch{ toast('⚠️ Ativado, mas sem aplicar tag.'); }
        }else{
          toast('🔕 Notificações desativadas.');
        }
        await atualizarDiagEstado();
      });
    });
  </script>
</body>
</html>