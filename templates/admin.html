<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Painel Admin</title>
  <link rel="manifest" href="/manifest.json" />
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">

  <!-- OneSignal -->
  <script src="https://cdn.onesignal.com/sdks/web/v16/OneSignalSDK.page.js" defer></script>
  <script>
    window.OneSignalDeferred = window.OneSignalDeferred || [];
    OneSignalDeferred.push(async function(OneSignal) {
      await OneSignal.init({
        appId: "2525d779-4ba0-490c-9ac7-b171167053f7",
        notifyButton: { enable: true }
      });
    });
  </script>

  <style>
    body { margin:0; font-family:Poppins,sans-serif; background:#f4f4f4; display:flex; height:100vh; }

    .sidebar { width:280px; background:#2c3e50; color:#fff; padding:15px; overflow-y:auto; }
    .sidebar h2 { font-size:18px; margin:0 0 15px; }
    .session { background:#34495e; padding:10px; border-radius:6px; margin-bottom:8px; cursor:pointer; }
    .session.active { background:#3498db; }

    .content { flex:1; display:flex; flex-direction:column; }

    .header { background:#2c3e50; color:#fff; padding:20px; display:flex; justify-content:space-between; align-items:center; }
    h1 { margin:0; }

    .btn { padding:10px 15px; border:none; border-radius:6px; cursor:pointer; font-weight:600; }
    .btn-primary { background:#3498db; color:#fff; }
    .btn-danger { background:#e74c3c; color:#fff; }

    .table { width:100%; margin-top:20px; border-collapse:collapse; background:#fff; }
    .table th,.table td { padding:12px; border:1px solid #ddd; text-align:left; }

    .toast-container { position:fixed; bottom:20px; right:20px; z-index:9999; }
    .toast { background:#2c3e50; color:#fff; padding:15px; border-radius:6px; margin-top:10px; }

    .modal { position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.6);display:flex;align-items:center;justify-content:center;z-index:999; }
    .modal-content { background:#fff;padding:20px;border-radius:8px;width:400px;max-width:95%; }
    .modal-content label { display:block;margin-top:10px;font-weight:500; }
    .progress-bar { width:0%;height:5px;background:green;margin-top:5px; }

    /* Chat */
    .chat { flex:1; display:flex; flex-direction:column; background:#fff; margin:15px; border-radius:8px; box-shadow:0 2px 6px rgba(0,0,0,0.1); }
    .chat-header { background:#3498db; color:#fff; padding:12px; font-weight:600; border-radius:8px 8px 0 0; }
    .chat-messages { flex:1; padding:15px; overflow-y:auto; display:flex; flex-direction:column; }
    .msg { max-width:60%; padding:10px 14px; border-radius:12px; margin-bottom:8px; word-wrap:break-word; }
    .msg.user { background:#ecf0f1; align-self:flex-start; }
    .msg.admin { background:#3498db; color:#fff; align-self:flex-end; }
    .chat-input { display:flex; border-top:1px solid #ddd; }
    .chat-input input { flex:1; border:none; padding:12px; font-size:14px; }
    .chat-input button { background:#3498db; color:#fff; border:none; padding:12px 18px; cursor:pointer; }
  </style>
</head>
<body>
  <div class="sidebar">
    <h2>ðŸ‘¥ UsuÃ¡rios Online</h2>
    <div id="sessions">Carregando...</div>
  </div>

  <div class="content">
    <div class="header">
      <h1>Painel Admin</h1>
      <div>
        <button id="btnPermissao" class="btn btn-primary">ðŸ”” Permitir NotificaÃ§Ãµes</button>
        <button class="btn btn-primary" onclick="openProductModal()">+ Novo Produto</button>
        <button class="btn btn-danger" onclick="logout()">Sair</button>
      </div>
    </div>

    <div id="products-table-container"></div>

    <div class="chat">
      <div class="chat-header" id="chat-header">Selecione um usuÃ¡rio</div>
      <div class="chat-messages" id="chat-messages"></div>
      <div class="chat-input">
        <input type="text" id="chat-text" placeholder="Digite sua mensagem..." disabled>
        <button onclick="sendMessage()" disabled id="send-btn">Enviar</button>
      </div>
    </div>
  </div>

  <div id="toast-container" class="toast-container"></div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { getFirestore } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
    import { getStorage, ref, uploadBytesResumable, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js";
    import { getMessaging, getToken, onMessage } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-messaging.js";

    const firebaseConfig = {
      apiKey: "AIzaSyB-rnG4cIZzEb1w_h_qmif3XPSx28ZIdaM",
      authDomain: "ecomercie-vendas.firebaseapp.com",
      projectId: "ecomercie-vendas",
      storageBucket: "ecomercie-vendas.firebasestorage.app",
      messagingSenderId: "1054540261609",
      appId: "1:1054540261609:web:90042b823220b4c73f6878",
      measurementId: "G-TNC5M9G89H"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const storage = getStorage(app);
    const messaging = getMessaging(app);

    if ("serviceWorker" in navigator) {
      navigator.serviceWorker.register("/firebase-messaging-sw.js");
    }

    onMessage(messaging, async (payload) => {
      const title = payload.notification?.title || "Nova NotificaÃ§Ã£o";
      const body  = payload.notification?.body  || "VocÃª recebeu uma mensagem";
      if (Notification.permission === "granted") {
        new Notification(title, { body, icon: "/icon-192.png" });
      }
      showToast(`${title} - ${body}`);
    });

    async function registerFcmToken(showAlert=false) {
      const user = auth.currentUser;
      if (!user) return;
      try {
        const token = await getToken(messaging, { vapidKey: "BNZLoKzBHSC6kWGUpglcgyo1_xkmS_zmO2ux_VDBEvn5Qai3NJeZfN2u612WVEvMyEao0e1V3rPeReBZVV2nNJg" });
        if (token) {
          const idToken = await user.getIdToken();
          await fetch("/api/save_fcm_token", {
            method: "POST",
            headers: { "Content-Type": "application/json", "Authorization": "Bearer " + idToken },
            body: JSON.stringify({ token })
          });
        }
      } catch (err) { console.error(err); }
    }

    document.getElementById("btnPermissao").addEventListener("click", async () => {
      const permission = await Notification.requestPermission();
      if (permission === "granted") registerFcmToken(true);
    });

    function showToast(msg) {
      const container = document.getElementById("toast-container");
      const toast = document.createElement("div");
      toast.className = "toast";
      toast.innerText = msg;
      container.appendChild(toast);
      setTimeout(() => toast.remove(), 5000);
    }

    async function renderProductsTable() {
      const user = auth.currentUser;
      if (!user) return;
      const idToken = await user.getIdToken();
      const res = await fetch("/api/my_products", { headers: { "Authorization": "Bearer " + idToken } });
      const products = await res.json();
      let html = `<table class="table"><tr><th>Nome</th><th>PreÃ§o</th><th>Imagem</th><th>VÃ­deo</th></tr>`;
      products.forEach(p => { 
        html += `<tr>
          <td>${p.nome}</td>
          <td>R$ ${(p.valor||0).toFixed(2)}</td>
          <td>${p.imagemUrl ? `<img src="${p.imagemUrl}" width="60">` : "-"}</td>
          <td>${p.videoUrl ? `<a href="${p.videoUrl}" target="_blank">Ver</a>` : "-"}</td>
        </tr>`;
      });
      html += `</table>`;
      document.getElementById("products-table-container").innerHTML = html;
    }

    // --- Modal Produto ---
    window.openProductModal = () => {
      const modal = document.createElement("div");
      modal.className = "modal";
      modal.innerHTML = `
        <div class="modal-content">
          <h3>Novo Produto</h3>
          <label>Nome:</label>
          <input id="nomeProd">
          <label>PreÃ§o:</label>
          <input id="valorProd" type="number" step="0.01">
          <label>Imagem:</label>
          <input id="imgProd" type="file" accept="image/*">
          <div id="img-progress" class="progress-bar"></div>
          <label>VÃ­deo:</label>
          <input id="videoProd" type="file" accept="video/*">
          <div id="vid-progress" class="progress-bar"></div>
          <button class="btn btn-primary" onclick="saveProduct()">Salvar</button>
          <button class="btn btn-danger" onclick="this.closest('.modal').remove()">Cancelar</button>
        </div>`;
      document.body.appendChild(modal);
    };

    async function uploadFile(file, progressId) {
      return new Promise((resolve, reject) => {
        const storageRef = ref(storage, `uploads/${Date.now()}_${file.name}`);
        const task = uploadBytesResumable(storageRef, file);
        task.on("state_changed", snap => {
          document.getElementById(progressId).style.width = (snap.bytesTransferred / snap.totalBytes * 100) + "%";
        }, reject, async () => {
          const url = await getDownloadURL(task.snapshot.ref);
          resolve(url);
        });
      });
    }

    window.saveProduct = async () => {
      const user = auth.currentUser;
      const idToken = await user.getIdToken();
      let imgUrl="", vidUrl="";
      const imgFile=document.getElementById("imgProd").files[0];
      const vidFile=document.getElementById("videoProd").files[0];
      if (imgFile) imgUrl = await uploadFile(imgFile,"img-progress");
      if (vidFile) vidUrl = await uploadFile(vidFile,"vid-progress");
      const produto={ nome:document.getElementById("nomeProd").value, valor:parseFloat(document.getElementById("valorProd").value)||0, imagemUrl:imgUrl, videoUrl:vidUrl };
      await fetch("/api/products",{
        method:"POST", headers:{"Content-Type":"application/json","Authorization":"Bearer "+idToken},
        body:JSON.stringify(produto)
      });
      document.querySelector(".modal").remove();
      renderProductsTable();
      showToast("âœ… Produto adicionado com sucesso!");
    };

    // --- Auth + Chat ---
    onAuthStateChanged(auth, (user) => {
      if (!user) { window.location.href="/login"; return; }
      renderProductsTable();
      loadSessions();
    });
    window.logout = ()=>signOut(auth);

    // --- CHAT ---
    let selectedSession = null;

    async function loadSessions() {
      try {
        const user = auth.currentUser;
        if (!user) return;
        const idToken = await user.getIdToken();

        const res = await fetch("/api/sessions", {
          headers: { "Authorization": "Bearer " + idToken }
        });
        const sessions = await res.json();
        const list = document.getElementById("sessions");
        list.innerHTML = "";
        sessions.forEach(s => {
          const div = document.createElement("div");
          div.className = "session" + (s.id === selectedSession ? " active" : "");
          div.textContent = `SessÃ£o: ${s.id.substring(0,6)}...`;
          div.onclick = () => selectSession(s.id);
          list.appendChild(div);
        });
      } catch (e) {
        console.error("Erro ao carregar sessÃµes:", e);
      }
    }

    async function selectSession(id) {
      selectedSession = id;
      document.getElementById("chat-header").textContent = "Chat com: " + id;
      document.getElementById("chat-text").disabled = false;
      document.getElementById("send-btn").disabled = false;
      loadMessages();
    }

    async function loadMessages() {
      if (!selectedSession) return;
      const user = auth.currentUser;
      const idToken = await user.getIdToken();

      const res = await fetch(`/api/get_messages/${selectedSession}`, {
        headers: { "Authorization": "Bearer " + idToken }
      });
      const msgs = await res.json();
      const box = document.getElementById("chat-messages");
      box.innerHTML = "";
      msgs.forEach(m => {
        const div = document.createElement("div");
        div.className = "msg " + (m.sender === "user" ? "user" : "admin");
        div.textContent = m.text;
        box.appendChild(div);
      });
      box.scrollTop = box.scrollHeight;
    }

    async function sendMessage() {
      const text = document.getElementById("chat-text").value.trim();
      if (!text || !selectedSession) return;
      await fetch("/api/send_message", {
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body:JSON.stringify({ session_id:selectedSession, text, sender:"admin" })
      });
      document.getElementById("chat-text").value = "";
      loadMessages();
    }

    setInterval(() => { loadSessions(); loadMessages(); }, 3000);
  </script>
</body>
</html>