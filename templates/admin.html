<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Painel Admin</title>
  <link rel="manifest" href="/manifest.json" />
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">

  <!-- OneSignal -->
  <script src="https://cdn.onesignal.com/sdks/web/v16/OneSignalSDK.page.js" defer></script>
  <script>
    window.OneSignalDeferred = window.OneSignalDeferred || [];
    OneSignalDeferred.push(async function(OneSignal) {
      await OneSignal.init({
        appId: "2525d779-4ba0-490c-9ac7-b171167053f7", // seu App ID do OneSignal
        notifyButton: { enable: true } // mostra o sininho
      });
    });
  </script>

  <style>
    body { margin:0; font-family:Poppins,sans-serif; background:#f4f4f4; }
    .header { background:#2c3e50; color:#fff; padding:20px; display:flex; justify-content:space-between; align-items:center; }
    h1 { margin:0; }
    .btn { padding:10px 15px; border:none; border-radius:6px; cursor:pointer; font-weight:600; }
    .btn-primary { background:#3498db; color:#fff; }
    .btn-danger { background:#e74c3c; color:#fff; }
    .table { width:100%; margin-top:20px; border-collapse:collapse; background:#fff; }
    .table th,.table td { padding:12px; border:1px solid #ddd; text-align:left; }
    .toast-container { position:fixed; bottom:20px; right:20px; z-index:9999; }
    .toast { background:#2c3e50; color:#fff; padding:15px; border-radius:6px; margin-top:10px; }
    .modal { position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.6);display:flex;align-items:center;justify-content:center;z-index:999; }
    .modal-content { background:#fff;padding:20px;border-radius:8px;width:400px;max-width:95%; }
    .modal-content label { display:block;margin-top:10px;font-weight:500; }
    .progress-bar { width:0%;height:5px;background:green;margin-top:5px; }
  </style>
</head>
<body>
  <div class="header">
    <h1>Painel Admin</h1>
    <div>
      <button id="btnPermissao" class="btn btn-primary">ðŸ”” Permitir NotificaÃ§Ãµes</button>
      <button class="btn btn-primary" onclick="openProductModal()">+ Novo Produto</button>
      <button class="btn btn-primary" onclick="window.location.href='/chat'">ðŸ’¬ Conversar com Clientes</button>
      <button class="btn btn-danger" onclick="logout()">Sair</button>
    </div>
  </div>

  <div id="products-table-container"></div>
  <div id="toast-container" class="toast-container"></div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { getFirestore } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
    import { getStorage, ref, uploadBytesResumable, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js";
    import { getMessaging, getToken, onMessage } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-messaging.js";

    const firebaseConfig = {
      apiKey: "AIzaSyB-rnG4cIZzEb1w_h_qmif3XPSx28ZIdaM",
      authDomain: "ecomercie-vendas.firebaseapp.com",
      projectId: "ecomercie-vendas",
      storageBucket: "ecomercie-vendas.firebasestorage.app",
      messagingSenderId: "1054540261609",
      appId: "1:1054540261609:web:90042b823220b4c73f6878",
      measurementId: "G-TNC5M9G89H"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const storage = getStorage(app);
    const messaging = getMessaging(app);

    // --- Service Worker
    if ("serviceWorker" in navigator) {
      navigator.serviceWorker.register("/firebase-messaging-sw.js")
      .then(() => console.log("âœ… SW registrado"))
      .catch(err => console.error("âŒ Erro SW:", err));
    }

    // --- Foreground notifications
    onMessage(messaging, async (payload) => {
      console.log("ðŸ“© Foreground msg:", payload);
      const title = payload.notification?.title || "Nova NotificaÃ§Ã£o";
      const body  = payload.notification?.body  || "VocÃª recebeu uma mensagem";

      if (Notification.permission === "default") {
        await Notification.requestPermission();
      }
      if (Notification.permission === "granted") {
        new Notification(title, { body, icon: "/icon-192.png" });
      }
      showToast(`${title} - ${body}`);
    });

    // --- Salvar token
    async function registerFcmToken(showAlert=false) {
      const user = auth.currentUser;
      if (!user) return;
      try {
        const token = await getToken(messaging, { vapidKey: "BNZLoKzBHSC6kWGUpglcgyo1_xkmS_zmO2ux_VDBEvn5Qai3NJeZfN2u612WVEvMyEao0e1V3rPeReBZVV2nNJg" });
        if (token) {
          console.log("âœ… Token FCM:", token);
          if (showAlert) alert("ðŸ“± Token gerado:\n" + token);
          const idToken = await user.getIdToken();
          await fetch("/api/save_fcm_token", {
            method: "POST",
            headers: { "Content-Type": "application/json", "Authorization": "Bearer " + idToken },
            body: JSON.stringify({ token })
          });
        } else {
          if (showAlert) alert("âŒ Nenhum token retornado. (iOS ainda nÃ£o liberou)");
        }
      } catch (err) {
        console.error("Erro ao gerar token:", err);
        if (showAlert) alert("Erro ao gerar token: " + err.message);
      }
    }

    // --- BotÃ£o Permitir NotificaÃ§Ãµes
    document.getElementById("btnPermissao").addEventListener("click", async () => {
      const permission = await Notification.requestPermission();
      if (permission === "granted") {
        registerFcmToken(true);
      } else {
        alert("âš ï¸ PermissÃ£o negada.");
      }
    });

    // --- Toast helper
    function showToast(msg) {
      const container = document.getElementById("toast-container");
      const toast = document.createElement("div");
      toast.className = "toast";
      toast.innerText = msg;
      container.appendChild(toast);
      setTimeout(() => toast.remove(), 5000);
    }

    // --- Render tabela produtos
    async function renderProductsTable() {
      const user = auth.currentUser;
      if (!user) return;
      const idToken = await user.getIdToken();
      const res = await fetch("/api/my_products", { headers: { "Authorization": "Bearer " + idToken } });
      const products = await res.json();
      if (!products.length) {
        document.getElementById("products-table-container").innerHTML = "<p>Nenhum produto ainda.</p>";
        return;
      }
      let html = `<table class="table"><tr><th>Nome</th><th>PreÃ§o</th><th>Imagem</th><th>VÃ­deo</th></tr>`;
      products.forEach(p => { 
        html += `<tr>
          <td>${p.nome}</td>
          <td>R$ ${(p.valor||0).toFixed(2)}</td>
          <td>${p.imagemUrl ? `<img src="${p.imagemUrl}" width="60">` : "-"}</td>
          <td>${p.videoUrl ? `<a href="${p.videoUrl}" target="_blank">Ver</a>` : "-"}</td>
        </tr>`;
      });
      html += `</table>`;
      document.getElementById("products-table-container").innerHTML = html;
    }

    // --- Modal Produto
    window.openProductModal = () => {
      const modal = document.createElement("div");
      modal.className = "modal";
      modal.innerHTML = `
        <div class="modal-content">
          <h3>Novo Produto</h3>
          <label>Nome:</label>
          <input id="nomeProd">
          <label>PreÃ§o:</label>
          <input id="valorProd" type="number" step="0.01">
          <label>Imagem:</label>
          <input id="imgProd" type="file" accept="image/*">
          <div id="img-progress" class="progress-bar"></div>
          <label>VÃ­deo:</label>
          <input id="videoProd" type="file" accept="video/*">
          <div id="vid-progress" class="progress-bar"></div>
          <button class="btn btn-primary" onclick="saveProduct()">Salvar</button>
          <button class="btn btn-danger" onclick="this.closest('.modal').remove()">Cancelar</button>
        </div>`;
      document.body.appendChild(modal);
    };

    // --- Upload helper
    async function uploadFile(file, progressId) {
      return new Promise((resolve, reject) => {
        const storageRef = ref(storage, `uploads/${Date.now()}_${file.name}`);
        const task = uploadBytesResumable(storageRef, file);
        task.on("state_changed", snap => {
          const pct = (snap.bytesTransferred / snap.totalBytes) * 100;
          document.getElementById(progressId).style.width = pct + "%";
        }, reject, async () => {
          const url = await getDownloadURL(task.snapshot.ref);
          resolve(url);
        });
      });
    }

    // --- Salvar produto
    window.saveProduct = async () => {
      const user = auth.currentUser;
      const idToken = await user.getIdToken();
      let imgUrl="", vidUrl="";
      const imgFile=document.getElementById("imgProd").files[0];
      const vidFile=document.getElementById("videoProd").files[0];
      if (imgFile) imgUrl = await uploadFile(imgFile,"img-progress");
      if (vidFile) vidUrl = await uploadFile(vidFile,"vid-progress");
      const produto={ nome:document.getElementById("nomeProd").value, valor:parseFloat(document.getElementById("valorProd").value)||0, imagemUrl:imgUrl, videoUrl:vidUrl };
      await fetch("/api/products",{
        method:"POST", headers:{"Content-Type":"application/json","Authorization":"Bearer "+idToken},
        body:JSON.stringify(produto)
      });
      document.querySelector(".modal").remove();
      renderProductsTable();
      showToast("âœ… Produto adicionado com sucesso!");
    };

    // --- Auth
    onAuthStateChanged(auth, (user) => {
      if (!user) { window.location.href="/login"; return; }
      renderProductsTable();
    });
    window.logout = ()=>signOut(auth);
  </script>
</body>
</html>
