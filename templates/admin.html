<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ecomercie ‚Äî Admin</title>

  <!-- PWA -->
  <link rel="manifest" href="/static/manifest.json" />
  <meta name="theme-color" content="#0b1220" />
  <link rel="icon" href="/static/icon-192.png" type="image/png" />
  <link rel="apple-touch-icon" href="/static/icon-512.png" />

  <style>
    :root { --bg:#0b1220; --fg:#e8eefc; --accent:#2ecc71; --warn:#ffb020; --err:#ff5a5f; }
    body { margin:0; font-family:system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; background:#f6f7fb; color:#1f2430;}
    header { background:var(--bg); color:var(--fg); padding:18px 20px; display:flex; align-items:center; justify-content:space-between; }
    header h1 { font-size:18px; margin:0; }
    main { max-width:920px; margin:26px auto; padding:0 16px; }
    .card { background:#fff; border-radius:12px; box-shadow:0 8px 24px rgba(15,23,42,.06); padding:18px; margin-bottom:16px; }
    .row { display:flex; gap:12px; flex-wrap:wrap; }
    button { border:0; border-radius:10px; padding:12px 16px; cursor:pointer; font-weight:600; }
    .primary { background:#2c7be5; color:#fff; }
    .ghost { background:#eef3ff; color:#1f2430; }
    .badge { display:inline-block; padding:6px 10px; border-radius:999px; font-size:12px; font-weight:700; }
    .ok { background:#e7f9ef; color:#0e8a4b; }
    .off { background:#ffe8e8; color:#b42318; }
    .muted { color:#667085; font-size:14px; }
    .toast { position:fixed; left:50%; transform:translateX(-50%); bottom:22px; background:#111827; color:#fff; padding:12px 16px; border-radius:10px; box-shadow:0 8px 24px rgba(0,0,0,.25); display:none; }
    .diag { font-size:13px; background:#f8fafc; border-radius:10px; padding:10px; }
  </style>
</head>
<body>
  <header>
    <h1>Ecomercie ‚Äî Painel do Admin</h1>
    <span id="status-badge" class="badge off">Push desativado</span>
  </header>

  <main>
    <section class="card">
      <h3>Notifica√ß√µes</h3>
      <p class="muted">Ative para receber alertas quando o cat√°logo for acessado. Ap√≥s a inscri√ß√£o, este dispositivo recebe a tag <code>role=admin</code>.</p>
      <div class="row" style="margin-top:10px">
        <button class="primary" onclick="ativarPush()">Ativar notifica√ß√µes</button>
        <button class="ghost"   onclick="testarPush()">Testar push (servidor)</button>
        <!-- opcional: <button class="ghost" onclick="reinstalarSW()">Reinstalar SW</button> -->
      </div>
      <div class="diag" style="margin-top:12px">
        <div>SDK carregado: <b id="d_sdk">n√£o</b></div>
        <div>Modo PWA (standalone): <b id="d_pwa">n√£o</b></div>
        <div>Push habilitado: <b id="d_enabled">desconhecido</b></div>
        <div>√öltima a√ß√£o: <b id="d_last">‚Äî</b></div>
      </div>
      <p id="info" class="muted" style="margin-top:8px"></p>
    </section>

    <section class="card">
      <h3>Dicas r√°pidas</h3>
      <ul class="muted">
        <li>iPhone (Safari): instale como app (Compartilhar ‚Üí <b>Adicionar √† Tela de In√≠cio</b>) e ative o push <b>dentro do app instalado</b>.</li>
        <li>Se negou a permiss√£o: Ajustes ‚Üí Notifica√ß√µes ‚Üí <i>Ecomercie Admin</i> ‚Üí permitir.</li>
      </ul>
    </section>
  </main>

  <div id="toast" class="toast"></div>

  <!-- SDK OneSignal -->
  <script src="https://cdn.onesignal.com/sdks/OneSignalSDK.js" async></script>

  <!-- ======= SEU SCRIPT COMPLETO ======= -->
  <script>
    // ==== UI helpers ====
    function toast(msg){const t=document.getElementById('toast');t.textContent=msg;t.style.display='block';clearTimeout(window.__t);window.__t=setTimeout(()=>t.style.display='none',3200);}
    function setBadge(on){const b=document.getElementById('status-badge');b.textContent=on?'Push ativo':'Push desativado';b.className='badge ' + (on?'ok':'off');}
    function setDiag(id,val){const el=document.getElementById(id); if(el) el.textContent=val;}

    const isiOS = /iPhone|iPad|iPod/i.test(navigator.userAgent);
    const isStandalone = ('standalone' in navigator) && navigator.standalone;
    setDiag('d_pwa', isStandalone ? 'sim' : 'n√£o');

    function mostrarInstrucoesDesbloqueio() {
      let msg = '';
      if (isiOS) {
        msg = isStandalone
          ? 'iPhone (PWA): Ajustes ‚Üí Notifica√ß√µes ‚Üí Ecomercie Admin ‚Üí Permitir.'
          : 'iPhone: instale como app (Compartilhar ‚Üí Adicionar √† Tela de In√≠cio), abra o app e tente de novo.';
      } else {
        const ua = navigator.userAgent.toLowerCase();
        if (ua.includes('chrome')) {
          msg = 'Chrome: cadeado ao lado do endere√ßo ‚Üí Permiss√µes ‚Üí Notifica√ß√µes ‚Üí Permitir.';
        } else if (ua.includes('firefox')) {
          msg = 'Firefox: √≠cone de permiss√µes (escudo/cadeado) ‚Üí Permiss√µes ‚Üí Notifica√ß√µes ‚Üí Permitir.';
        } else if (ua.includes('safari')) {
          msg = 'Safari (macOS): Safari ‚Üí Prefer√™ncias ‚Üí Websites ‚Üí Notifications ‚Üí Allow para este site.';
        } else if (ua.includes('edg/')) {
          msg = 'Edge: cadeado ao lado do endere√ßo ‚Üí Permiss√µes do site ‚Üí Notifica√ß√µes ‚Üí Permitir.';
        } else {
          msg = 'Ative as notifica√ß√µes nas permiss√µes do site/navegador para este dom√≠nio.';
        }
      }
      toast('‚ö†Ô∏è Permiss√£o est√° bloqueada. ' + msg);
    }

    // opcional: limpar SW antigo (especialmente √∫til no iOS)
    async function reinstalarSW(){
      setDiag('d_last','clicou: Reinstalar SW');
      if ('serviceWorker' in navigator) {
        const regs = await navigator.serviceWorker.getRegistrations();
        for (const r of regs) { try { await r.unregister(); } catch(e){} }
        toast('SW removido. Recarregando‚Ä¶'); setTimeout(()=>location.reload(), 600);
      } else {
        toast('Este navegador n√£o tem serviceWorker.');
      }
    }
    window.reinstalarSW = reinstalarSW;

    async function ativarPush(){
      setDiag('d_last','clicou: Ativar notifica√ß√µes');

      if (isiOS && !isStandalone) { toast('üì≤ No iPhone, instale como app (Tela de In√≠cio) para habilitar push.'); return; }
      if (!window.OneSignal){ toast('‚åõ SDK ainda carregando‚Ä¶'); return; }

      if (typeof Notification !== 'undefined' && Notification.permission === 'denied') {
        mostrarInstrucoesDesbloqueio();
        return;
      }

      try {
        const supported = await OneSignal.isPushNotificationsSupported?.();
        if (supported === false) { toast('‚ùå Este ambiente n√£o suporta Web Push.'); return; }

        const already = await OneSignal.isPushNotificationsEnabled();
        if (already){
          try { await OneSignal.sendTag('role','admin'); } catch(e){}
          setBadge(true); setDiag('d_enabled','sim'); toast('‚úÖ J√° est√° ativado (marcado como ADMIN).');
          return;
        }

        // Sequ√™ncia ‚Äúmais forte‚Äù (SDK novo) ‚Üí fallback legado
        if (OneSignal.Notifications?.requestPermission) { await OneSignal.Notifications.requestPermission(); }
        if (OneSignal.User?.PushSubscription?.optIn) { try { await OneSignal.User.PushSubscription.optIn(); } catch(e){} }
        if (OneSignal.Slidedown?.promptPush) { await OneSignal.Slidedown.promptPush(); }
        else if (OneSignal.showSlidedownPrompt) { await OneSignal.showSlidedownPrompt(); }

        const enabledNow = await OneSignal.isPushNotificationsEnabled();
        setBadge(enabledNow); setDiag('d_enabled', enabledNow ? 'sim' : 'n√£o');

        if (enabledNow) {
          try { await OneSignal.sendTag('role','admin'); } catch(e){}
          toast('‚úÖ Ativado e marcado como ADMIN.');
        } else {
          if (typeof Notification !== 'undefined' && Notification.permission === 'denied') {
            mostrarInstrucoesDesbloqueio();
          } else {
            toast('‚ö†Ô∏è Permiss√£o n√£o conclu√≠da. Tente novamente.');
          }
        }
      } catch (e) {
        console.log(e);
        toast('‚ùå Erro ao solicitar permiss√£o.');
      }
    }
    window.ativarPush = ativarPush;

    async function testarPush(){
      setDiag('d_last','clicou: Testar push');
      try {
        const r = await fetch('/test-notify', { cache: 'no-store' });
        const j = await r.json();
        toast(j.sent ? 'üì® Push de teste enviado!' : '‚ùå Falha ao enviar push.');
      } catch { toast('‚ùå Erro ao chamar o servidor.'); }
    }
    window.testarPush = testarPush;

    // ==== Inicializa√ß√£o OneSignal ====
    window.OneSignal = window.OneSignal || [];
    OneSignal.push(async function () {
      setDiag('d_sdk','sim');

      OneSignal.init({
        appId: "2525d779-4ba0-490c-9ac7-b117167053f7",
        notifyButton: { enable: true, position: "bottom-right", prenotify: true, showCredit: false }
      });

      try {
        const supported = await OneSignal.isPushNotificationsSupported?.();
        if (supported === false) toast('‚ö†Ô∏è Este navegador n√£o suporta Web Push.');
      } catch {}

      try {
        const enabled = await OneSignal.isPushNotificationsEnabled();
        setBadge(enabled);
        setDiag('d_enabled', enabled ? 'sim' : 'n√£o');
        document.getElementById('info').textContent = enabled
          ? 'Este dispositivo j√° est√° inscrito para receber push.'
          : 'Clique em "Ativar notifica√ß√µes" para se inscrever.';
        if (enabled) { try { await OneSignal.sendTag('role','admin'); } catch(e){} }
      } catch {}

      OneSignal.on('subscriptionChange', async (ok) => {
        setBadge(ok); setDiag('d_enabled', ok ? 'sim' : 'n√£o');
        if (ok) {
          try { await OneSignal.sendTag('role','admin'); toast('‚úÖ Ativado e marcado como ADMIN.'); }
          catch(e){ console.log(e); toast('‚ö†Ô∏è Ativado, mas falhou ao aplicar a tag.'); }
        } else {
          toast('üîï Notifica√ß√µes desativadas.');
        }
      });
    });
  </script>
</body>
</html>
