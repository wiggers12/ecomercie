<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel de Controle</title>
    <link rel="manifest" href="/manifest.json">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <style>
        :root { --primary: #3498db; --secondary: #2ecc71; --danger: #e74c3c; --dark1: #2c3e50; --dark2: #34495e; --light1: #ecf0f1; --light2: #bdc3c7; }
        body { margin: 0; font-family: 'Poppins', sans-serif; background-color: var(--light1); font-size: 16px; display: flex; flex-direction: column; min-height: 100vh; }
        .mobile-header { display: none; background-color: var(--dark1); color: var(--light1); padding: 15px 20px; justify-content: space-between; align-items: center; box-shadow: 0 2px 5px rgba(0,0,0,0.2); position: sticky; top: 0; z-index: 1100; }
        .sidebar { width: 250px; background-color: var(--dark1); color: var(--light1); display: flex; flex-direction: column; justify-content: space-between; padding: 20px; box-shadow: 2px 0 5px rgba(0,0,0,0.2); z-index: 1000; }
        .sidebar h2 { text-align: center; color: var(--light1); margin-bottom: 30px; font-size: 24px; }
        .sidebar nav a { display: flex; align-items: center; color: var(--light2); text-decoration: none; padding: 15px; margin: 5px 0; border-radius: 8px; transition: background-color 0.3s, color 0.3s; }
        .sidebar nav a:hover, .sidebar nav a.active { background-color: var(--dark2); color: var(--light1); }
        .sidebar nav a i { margin-right: 12px; font-size: 18px; }
        .app-container { display: flex; flex-grow: 1; }
        .main-content { flex-grow: 1; padding: 30px; overflow-y: auto; }
        .view { display: none; }
        .view.active { display: block; animation: fadeIn 0.5s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; border-bottom: 1px solid var(--light2); padding-bottom: 15px; gap: 10px; flex-wrap: wrap; }
        h1 { margin: 0; color: var(--dark1); font-size: 28px; }
        .btn { padding: 10px 18px; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; transition: all 0.2s; font-size: 15px; }
        .btn i { margin-right: 8px; }
        .btn-primary { background-color: var(--primary); color: white; }
        .btn-primary:hover { background-color: #2980b9; transform: translateY(-1px); }
        .btn-secondary { background-color: var(--secondary); color: white; }
        .btn-secondary:hover { background-color: #27ae60; }
        .table-responsive { overflow-x: auto; margin-top: 20px; }
        .table { width: 100%; border-collapse: collapse; background-color: white; box-shadow: 0 2px 10px rgba(0,0,0,0.08); border-radius: 8px; overflow: hidden; min-width: 600px; }
        .table th, .table td { padding: 15px; text-align: left; border-bottom: 1px solid var(--light1); }
        .table th { background-color: var(--dark2); color: var(--light1); font-weight: 600; }
        .table img { width: 60px; height: 40px; object-fit: cover; border-radius: 4px; }
        .actions a { margin: 0 8px; color: var(--dark1); cursor: pointer; font-size: 18px; transition: color 0.3s; }
        .actions a:hover { color: var(--primary); }
        #toast-container { position: fixed; bottom: 20px; right: 20px; z-index: 2000; display: flex; flex-direction: column-reverse; gap: 10px; }
        .toast { background-color: var(--dark1); color: var(--light1); padding: 15px 20px; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.2); display: flex; align-items: center; gap: 15px; opacity: 0; transform: translateX(100%); animation: slideIn 0.5s forwards, fadeOut 0.5s 4.5s forwards; }
        .toast i { color: var(--secondary); font-size: 24px; }
        @keyframes slideIn { to { opacity: 1; transform: translateX(0); } }
        @keyframes fadeOut { from { opacity: 1; transform: translateX(0); } to { opacity: 0; transform: translateX(100%); } }
    </style>
</head>
<body>

<div class="mobile-header" id="mobile-header">
    <i class="fas fa-bars menu-icon" onclick="toggleSidebar()"></i>
    <h2>Painel Admin</h2>
    <div style="width: 24px;"></div>
</div>

<div class="app-container">
    <aside class="sidebar" id="sidebar">
        <div>
            <h2>Meu Cat√°logo</h2>
            <nav>
                <a href="#" onclick="showView('view-products')" class="active"><i class="fas fa-box-open"></i> Produtos</a>
                <a href="#" onclick="showView('view-clients')"><i class="fas fa-users"></i> Clientes</a>
                <a href="/" target="_blank"><i class="fas fa-eye"></i> Ver Cat√°logo</a>
            </nav>
        </div>
        <nav>
             <a href="#" onclick="logout()"><i class="fas fa-sign-out-alt"></i> Sair</a>
        </nav>
    </aside>
    <main class="main-content">
        <div id="view-products" class="view">
            <div class="header">
                <h1>Gerenciar Produtos</h1>
                <button class="btn btn-primary" onclick="openProductModal()"><i class="fas fa-plus"></i> Novo Produto</button>
                <button class="btn btn-secondary" onclick="ativarNotificacoes()"><i class="fas fa-bell"></i> Ativar Notifica√ß√µes</button>
            </div>
            <div class="table-responsive"><div id="products-table-container"></div></div>
        </div>
        <div id="view-clients" class="view">
            <div class="header"><h1>Clientes Cadastrados</h1></div>
            <p>Funcionalidade de clientes a ser implementada.</p>
        </div>
    </main>
</div>

<div id="toast-container"></div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { getFirestore, collection, onSnapshot, query, where } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
    import { getStorage, ref, uploadBytesResumable, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js";
    import { getMessaging, getToken, onMessage } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-messaging.js";

    const firebaseConfig = {
        apiKey: "AIzaSyB-rnG4cIZzEb1w_h_qmif3XPSx28ZIdaM",
        authDomain: "ecomercie-vendas.firebaseapp.com",
        projectId: "ecomercie-vendas",
        storageBucket: "ecomercie-vendas.firebasestorage.app",
        messagingSenderId: "1054540261609",
        appId: "1:1054540261609:web:90042b823220b4c73f6878",
        measurementId: "G-TNC5M9G89H"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const storage = getStorage(app);
    const messaging = getMessaging(app);

    // üîî bot√£o manual para iOS
    window.ativarNotificacoes = async function() {
        try {
            const perm = await Notification.requestPermission();
            if (perm === "granted") {
                console.log("‚úÖ Notifica√ß√µes autorizadas pelo usu√°rio");
                await registerFcmToken();
                showNotification("Notifica√ß√µes ativadas com sucesso!");
            } else {
                console.warn("‚ùå Permiss√£o negada:", perm);
                alert("Ative as notifica√ß√µes nas configura√ß√µes do navegador.");
            }
        } catch (e) {
            console.error("Erro ao ativar notifica√ß√µes:", e);
        }
    }

    // Recebe notifica√ß√µes em primeiro plano
    onMessage(messaging, (payload) => {
        console.log("üì© Mensagem recebida no admin:", payload);
        const title = payload.notification?.title || "Nova Notifica√ß√£o";
        const body  = payload.notification?.body || "Voc√™ recebeu uma nova mensagem";
        showNotification(`${title} - ${body}`);
    });

    async function registerFcmToken() {
        const user = auth.currentUser;
        if (!user) return;
        const token = await getToken(messaging, { vapidKey: "BNZLoKzBHSC6kWGUpglcgyo1_xkmS_zmO2ux_VDBEvn5Qai3NJeZfN2u612WVEvMyEao0e1V3rPeReBZVV2nNJg" });
        if (token) {
            const idToken = await user.getIdToken();
            await fetch("/api/save_fcm_token", {
                method: "POST",
                headers: { "Content-Type": "application/json", "Authorization": "Bearer " + idToken },
                body: JSON.stringify({ token })
            });
            console.log("Token FCM registrado:", token);
        }
    }

    function showNotification(message) {
        const container = document.getElementById('toast-container');
        const toast = document.createElement('div');
        toast.className = 'toast';
        toast.innerHTML = `<i class="fas fa-bell"></i> <div>${message}</div>`;
        container.appendChild(toast);
        setTimeout(() => { toast.remove(); }, 5000);
    }

    // Controle de views
    window.showView = function(viewId) {
        document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
        document.getElementById(viewId).classList.add('active');
    }

    window.logout = async function() { await signOut(auth); }
</script>

</body>
</html>