<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ecomercie ‚Äî Admin</title>

  <!-- PWA -->
  <link rel="manifest" href="/static/manifest.json" />
  <meta name="theme-color" content="#0b1220" />
  <link rel="icon" href="/static/icon-192.png" type="image/png" />
  <link rel="apple-touch-icon" href="/static/icon-512.png" />

  <style>
    :root { --bg:#0b1220; --fg:#e8eefc; --accent:#2ecc71; --warn:#ffb020; --err:#ff5a5f; }
    body { margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; background:#f6f7fb; color:#1f2430;}
    header { background:var(--bg); color:var(--fg); padding:18px 20px; display:flex; align-items:center; justify-content:space-between; }
    header h1 { font-size:18px; margin:0; }
    main { max-width:920px; margin:26px auto; padding:0 16px; }
    .card { background:#fff; border-radius:12px; box-shadow:0 8px 24px rgba(15,23,42,.06); padding:18px; margin-bottom:16px; }
    .row { display:flex; gap:12px; flex-wrap:wrap; align-items:center; }
    button, .button-link { border:0; border-radius:10px; padding:12px 16px; cursor:pointer; font-weight:600; font-family:inherit; font-size:14px; }
    .primary { background:#2c7be5; color:#fff; }
    .ghost { background:#eef3ff; color:#1f2430; }
    .danger { background:#ffeaea; color:#b42318; }
    .badge { display:inline-block; padding:6px 10px; border-radius:999px; font-size:12px; font-weight:700; }
    .ok { background:#e7f9ef; color:#0e8a4b; }
    .off { background:#ffe8e8; color:#b42318; }
    .muted { color:#667085; font-size:14px; }
    .toast { position:fixed; left:50%; transform:translateX(-50%); bottom:22px; background:#111827; color:#fff; padding:12px 16px; border-radius:10px; box-shadow:0 8px 24px rgba(0,0,0,.25); display:none; z-index:9999; }
    .diag { font-size:13px; background:#f8fafc; border-radius:10px; padding:10px; }
    code { background:#eef2f7; padding:1px 6px; border-radius:6px; }
    a.primary, a.ghost, a.danger { text-decoration:none; }
    .pill { background:#eef2f7; color:#1f2430; border-radius:999px; padding:6px 10px; font-size:12px; font-weight:700; }
  </style>
</head>
<body>
  <header>
    <h1>Ecomercie ‚Äî Painel do Admin</h1>
    <div class="row">
      <span id="tenant-pill" class="pill">Loja: ‚Äî</span>
      <span id="status-badge" class="badge off">Push desativado</span>
    </div>
  </header>

  <main>
    <!-- HUB / ATALHOS -->
    <section class="card">
      <h3>Acessos r√°pidos</h3>
      <p class="muted">Este admin √© um ‚Äúhospedeiro‚Äù. Use os bot√µes abaixo para abrir os pain√©is.</p>
      <div class="row" style="margin-top:10px">
        <a id="lnkEstoque" class="primary button-link" href="#">Abrir Estoque</a>
        <a id="lnkFinanceiro" class="ghost button-link" href="#">Abrir Financeiro</a>
        <a id="lnkCatalogo" class="ghost button-link" href="#">Abrir Cat√°logo</a>
      </div>
    </section>

    <!-- PUSH -->
    <section class="card">
      <h3>Notifica√ß√µes</h3>
      <p class="muted">
        Ative para receber alertas quando o cat√°logo for acessado. Ap√≥s a inscri√ß√£o, este dispositivo recebe as tags
        <code>role=admin</code> e <code>tenant=&lt;sualoja&gt;</code>.
      </p>
      <div class="row" style="margin-top:10px">
        <button class="primary" onclick="ativarPush()">Ativar notifica√ß√µes</button>
        <button class="ghost"   onclick="testarPush()">Testar push (servidor)</button>
        <button class="ghost"   onclick="fixarAdmin()">Reaplicar tags</button>
        <button class="danger"  onclick="resetarPush()">Resetar push</button>
      </div>
      <div class="diag" style="margin-top:12px">
        <div>SDK carregado: <b id="d_sdk">n√£o</b></div>
        <div>Suporte a Web Push: <b id="d_support">desconhecido</b></div>
        <div>Permiss√£o do navegador: <b id="d_perm">desconhecida</b></div>
        <div>Modo PWA (standalone): <b id="d_pwa">n√£o</b></div>
        <div>Push habilitado: <b id="d_enabled">desconhecido</b></div>
        <div>Subscription ID: <code id="d_sid">‚Äî</code></div>
        <div>√öltima a√ß√£o: <b id="d_last">‚Äî</b></div>
      </div>
      <p id="info" class="muted" style="margin-top:8px"></p>
    </section>

    <!-- OUTRAS FERRAMENTAS -->
    <section class="card">
      <h3>Ferramentas Externas</h3>
      <p class="muted">Acesse outras plataformas importantes para o gerenciamento da loja.</p>
      <div class="row" style="margin-top:10px">
        <a href="https://dashboard.tawk.to/" target="_blank" class="primary">Acessar Chat (Tawk.to)</a>
      </div>
    </section>

    <section class="card">
      <h3>Dicas r√°pidas</h3>
      <ul class="muted">
        <li><b>iPhone</b>: instale como app (Compartilhar ‚Üí <b>Adicionar √† Tela de In√≠cio</b>) e ative o push <b>dentro do app instalado</b>.</li>
        <li>Se negou a permiss√£o: Ajustes ‚Üí Notifica√ß√µes ‚Üí <i>Ecomercie Admin</i> ‚Üí Permitir.</li>
      </ul>
    </section>
  </main>

  <div id="toast" class="toast"></div>

  <!-- OneSignal SDK -->
  <script src="https://cdn.onesignal.com/sdks/OneSignalSDK.js" async></script>

  <script>
    /* ========= helpers UI ========= */
    function toast(msg){ const t=document.getElementById('toast'); t.textContent=msg; t.style.display='block'; clearTimeout(window.__t); window.__t=setTimeout(()=>t.style.display='none',3200); }
    function setBadge(on){ const b=document.getElementById('status-badge'); b.textContent=on?'Push ativo':'Push desativado'; b.className='badge ' + (on?'ok':'off'); }
    function setDiag(id,val){ const el=document.getElementById(id); if(el) el.textContent = (val ?? '').toString(); }
    const isiOS = /iPhone|iPad|iPod/i.test(navigator.userAgent);
    const isStandalone = ('standalone' in navigator) && navigator.standalone;
    setDiag('d_pwa', isStandalone ? 'sim' : 'n√£o');
    setDiag('d_perm', (typeof Notification!=='undefined' ? Notification.permission : 'n/a'));

    /* ========= tenant & navega√ß√£o ========= */
    function getTenant(){ const p = location.pathname.split('/').filter(Boolean); return p.length>=2 ? p[0] : 'default'; }
    const TENANT = getTenant();
    document.getElementById('tenant-pill').textContent = `Loja: ${TENANT}`;
    // define links
    document.getElementById('lnkEstoque').href    = `/${TENANT}/estoque`;
    document.getElementById('lnkFinanceiro').href = `/${TENANT}/financeiro`;
    document.getElementById('lnkCatalogo').href   = `/${TENANT}/catalogo`;

    /* ========= OneSignal ========= */
    async function getSubscriptionId(){
      try{ const id = await OneSignal?.User?.PushSubscription?.id; if(id) return id; }catch(_){}
      try{ if (OneSignal.getUserId) return await OneSignal.getUserId(); }catch(_){}
      return null;
    }
    async function tagTenantAndRole(){
      try{
        await OneSignal.sendTag('role','admin');
        await OneSignal.sendTag('tenant', TENANT);
      }catch(_){}
    }
    async function atualizarDiagEstado(){
      try{
        const supported = await OneSignal.isPushNotificationsSupported?.();
        setDiag('d_support', supported === false ? 'n√£o' : 'sim');
      }catch{ setDiag('d_support','sim'); }
      setDiag('d_perm', (typeof Notification!=='undefined' ? Notification.permission : 'n/a'));
      try{
        const enabled = await OneSignal.isPushNotificationsEnabled();
        setBadge(enabled);
        setDiag('d_enabled', enabled ? 'sim':'n√£o');
      }catch{ setBadge(false); setDiag('d_enabled','n√£o'); }
      try{
        const sid = await getSubscriptionId();
        setDiag('d_sid', sid || '‚Äî');
      }catch{ setDiag('d_sid','‚Äî'); }
    }
    function instrucoesDesbloqueio(){
      if(isiOS){
        return isStandalone
          ? 'Ajustes ‚Üí Notifica√ß√µes ‚Üí Ecomercie Admin ‚Üí Permitir.'
          : 'Instale como app (Compartilhar ‚Üí Adicionar √† Tela de In√≠cio) e abra o app.';
      }
      return 'Verifique as Permiss√µes do site (cadeado ao lado do endere√ßo) e permita Notifica√ß√µes.';
    }

    async function ativarPush(){
      setDiag('d_last','clicou: Ativar notifica√ß√µes');
      if (isiOS && !isStandalone){ toast('üì≤ No iPhone, instale como app (Tela de In√≠cio).'); return; }
      if (!window.OneSignal){ toast('‚åõ SDK ainda carregando‚Ä¶'); return; }
      if (typeof Notification!=='undefined' && Notification.permission==='denied'){ toast('‚ö†Ô∏è Permiss√£o bloqueada. ' + instrucoesDesbloqueio()); return; }

      try{
        const supported = await OneSignal.isPushNotificationsSupported?.();
        if (supported === false){ toast('‚ùå Este ambiente n√£o suporta Web Push.'); return; }

        if (await OneSignal.isPushNotificationsEnabled()){
          await tagTenantAndRole();
          toast('‚úÖ J√° est√° ativado (ADMIN/tenant).');
          await atualizarDiagEstado();
          return;
        }

        if (OneSignal.Notifications?.requestPermission){
          const r = await OneSignal.Notifications.requestPermission(); // granted/denied/default
          setDiag('d_perm', r);
          if (r==='denied'){ toast('‚ö†Ô∏è Permiss√£o negada. ' + instrucoesDesbloqueio()); return; }
        }
        if (OneSignal.User?.PushSubscription?.optIn){
          try{ await OneSignal.User.PushSubscription.optIn(); }catch(_){}
        }

        if (OneSignal.Slidedown?.promptPush)      { await OneSignal.Slidedown.promptPush(); }
        else if (OneSignal.showSlidedownPrompt)   { await OneSignal.showSlidedownPrompt(); }

        const enabledNow = await OneSignal.isPushNotificationsEnabled();
        setBadge(enabledNow);
        setDiag('d_enabled', enabledNow ? 'sim':'n√£o');

        if (enabledNow){
          await tagTenantAndRole();
          const sid = await getSubscriptionId();
          setDiag('d_sid', sid || '‚Äî');
          toast('‚úÖ Ativado e marcado como ADMIN/tenant.');
        }else{
          if (typeof Notification!=='undefined' && Notification.permission==='default'){
            toast('‚ö†Ô∏è Confirme o pedido de permiss√£o do sistema.');
          }else{
            toast('‚ö†Ô∏è Permiss√£o n√£o conclu√≠da. ' + instrucoesDesbloqueio());
          }
        }
      }catch(e){
        console.log(e);
        toast('‚ùå Erro ao solicitar permiss√£o.');
      }
      await atualizarDiagEstado();
    }

    async function fixarAdmin(){
      setDiag('d_last','clicou: Reaplicar tags');
      if (!window.OneSignal){ toast('SDK ainda carregando‚Ä¶'); return; }
      try{ await tagTenantAndRole(); toast('üè∑Ô∏è Tags reaplicadas.'); }
      catch{ toast('‚ö†Ô∏è Falhou ao aplicar tags.'); }
    }

    async function testarPush(){
      setDiag('d_last','clicou: Testar push');
      try{
        const r = await fetch('/test-notify', { cache:'no-store' });
        const j = await r.json();
        const ok = j.ok === true || j.sent === true;
        toast(ok ? 'üì® Push (admins) enviado!' : '‚ùå Falha no envio.');
        console.log('test-notify ‚Üí', j);
      }catch{
        toast('‚ùå Erro ao chamar o servidor.');
      }
    }

    async function resetarPush(){
      setDiag('d_last','clicou: Resetar push');
      try{
        if (OneSignal?.User?.PushSubscription?.optOut) {
          try{ await OneSignal.User.PushSubscription.optOut(); }catch(_){}
        }
        if ('serviceWorker' in navigator){
          const regs = await navigator.serviceWorker.getRegistrations();
          for (const r of regs){ try{ await r.unregister(); }catch(_){ } }
        }
        setBadge(false); setDiag('d_enabled','n√£o'); setDiag('d_sid','‚Äî');
        toast('üîÑ SW removido / inscri√ß√£o limpa. Reabra e ative novamente.');
        setTimeout(()=>location.reload(), 700);
      }catch{
        toast('‚ö†Ô∏è N√£o foi poss√≠vel resetar.');
      }
    }

    window.ativarPush=ativarPush; window.fixarAdmin=fixarAdmin; window.testarPush=testarPush; window.resetarPush=resetarPush;

    // Inicializa√ß√£o OneSignal
    window.OneSignal = window.OneSignal || [];
    OneSignal.push(async () => {
      setDiag('d_sdk','sim');
      OneSignal.init({
        appId: "2525d779-4ba0-490c-9ac7-b117167053f7",
        notifyButton: { enable:true, position:"bottom-right", prenotify:true, showCredit:false }
      });
      await atualizarDiagEstado();
      OneSignal.on('subscriptionChange', async (ok)=>{
        setBadge(ok); setDiag('d_enabled', ok?'sim':'n√£o');
        if (ok){
          try{ await tagTenantAndRole(); toast('‚úÖ Ativado e marcado como ADMIN/tenant.'); }
          catch{ toast('‚ö†Ô∏è Ativado, mas sem aplicar tags.'); }
        }else{
          toast('üîï Notifica√ß√µes desativadas.');
        }
        await atualizarDiagEstado();
      });
    });
  </script>
</body>
</html>