<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Financeiro — Ecomercie</title>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3"></script>

<style>
  :root{
    --bg:#0b1220; --fg:#e8eefc; --muted:#667085;
    --card:#ffffff; --shadow:0 10px 30px rgba(15,23,42,.08);
    --pri:#2c7be5; --ok:#12b981; --warn:#f59e0b; --err:#ef4444; --line:#eef2f7;
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:#f6f7fb;color:#111}
  header{background:var(--bg);color:var(--fg);padding:18px 20px;display:flex;align-items:center;justify-content:space-between;gap:12px}
  header h1{font-size:18px;margin:0}
  main{max-width:1200px;margin:24px auto;padding:0 16px}
  .row{display:flex;gap:14px;flex-wrap:wrap}
  .card{background:var(--card);border-radius:14px;box-shadow:var(--shadow);padding:16px}
  .kpi{flex:1 1 220px}
  .kpi .lbl{color:var(--muted);font-size:12px}
  .kpi .val{font-size:24px;font-weight:800;margin-top:6px}
  .toolbar{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  select,input[type="date"]{border:1px solid #d0d5dd;border-radius:10px;padding:10px 12px;font:inherit}
  .btn{border:0;border-radius:10px;padding:10px 14px;font-weight:700;cursor:pointer}
  .btn.ghost{background:#eef3ff;color:#0b1220}
  table{width:100%;border-collapse:collapse}
  th,td{padding:12px;border-bottom:1px solid var(--line);font-size:14px}
  tr:hover{background:#fafbff}
  .right{margin-left:auto}
  /* Botão Voltar */
  .back-btn{display:inline-flex;align-items:center;gap:8px;background:#eef3ff;color:#1f2430;border:0;cursor:pointer;padding:10px 14px;border-radius:10px;font-weight:700;font-size:14px}
  .back-btn:hover{background:#e1e9ff}
  .back-btn svg{width:18px;height:18px}
</style>
</head>
<body>
<header>
  <button class="back-btn" onclick="goBack()" title="Voltar para o Admin">
    <svg viewBox="0 0 24 24" fill="currentColor" aria-hidden="true"><path d="M15.5 19a1 1 0 0 1-.7-.29l-6-6a1 1 0 0 1 0-1.42l6-6a1 1 0 1 1 1.4 1.42L10.9 12l5.3 5.29A1 1 0 0 1 15.5 19z"/></svg>
    Voltar
  </button>
  <h1>Financeiro — Ecomercie</h1>
  <div class="toolbar">
    <select id="range">
      <option value="7">7 dias</option>
      <option value="30" selected>30 dias</option>
      <option value="90">90 dias</option>
      <option value="all">Tudo</option>
    </select>
    <input type="date" id="d1">
    <input type="date" id="d2">
    <button class="btn ghost" id="btnCSV">Exportar CSV</button>
  </div>
</header>

<main>
  <!-- KPIs -->
  <section class="row">
    <div class="card kpi"><div class="lbl">Receita (bruta)</div><div class="val" id="k_rev">R$ 0,00</div></div>
    <div class="card kpi"><div class="lbl">Pedidos</div><div class="val" id="k_orders">0</div></div>
    <div class="card kpi"><div class="lbl">Ticket médio</div><div class="val" id="k_aov">R$ 0,00</div></div>
    <div class="card kpi"><div class="lbl">Pago / Pendente</div><div class="val" id="k_status">0 / 0</div></div>
  </section>

  <!-- Charts -->
  <section class="row">
    <div class="card" style="flex:2 1 520px">
      <div class="lbl">Receita por dia</div>
      <canvas id="chartRev"></canvas>
    </div>
    <div class="card" style="flex:1 1 360px">
      <div class="lbl">Top produtos</div>
      <canvas id="chartTop"></canvas>
    </div>
  </section>

  <!-- Tabela -->
  <section class="card">
    <div class="lbl" style="margin-bottom:6px">Pedidos (clique no status para alterar)</div>
    <table>
      <thead>
        <tr>
          <th>Data</th><th>Pedido</th><th>Produto</th><th>Qtd</th><th>Valor</th><th>Status</th>
        </tr>
      </thead>
      <tbody id="tbody"></tbody>
    </table>
  </section>
</main>

<script type="module">
import { db } from "/static/firebase-init.js";
import { collection, onSnapshot, orderBy, query, doc, updateDoc } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-firestore.js";

/* ---------- Helpers ---------- */
const $ = id => document.getElementById(id);
const brl = n => (Number(n)||0).toLocaleString('pt-BR',{style:'currency',currency:'BRL'});
function tenant(){ const p=location.pathname.split('/').filter(Boolean); return p.length>=2 ? p[0] : 'default'; }
const TENANT = tenant();
const colOrders = () => collection(db, `tenants/${TENANT}/orders`);

let ORDERS = [];       // pedidos completos do Firestore
let FILTERED = [];     // pedidos após filtro de data
let LINES = [];        // linhas (itens) para tabela/gráficos

// Total do pedido (suporta orders com items[] ou price/qty)
function orderTotal(o){
  if (Array.isArray(o.items) && o.items.length){
    return o.items.reduce((s,it)=> s + Number(it.price||0)*Number(it.qty||1), 0);
  }
  return Number(o.price||0)*Number(o.qty||1);
}

// Expande um pedido em linhas de itens (para tabela/top produtos)
function orderToLines(o){
  const dt = o.createdAt?.toDate?.() || new Date();
  const st = (o.status === 'new') ? 'pending' : (o.status||'pending');
  if (Array.isArray(o.items) && o.items.length){
    return o.items.map(it => ({
      orderId: o.id,
      createdAt: dt,
      productName: it.name || it.productName || '(sem nome)',
      qty: Number(it.qty||1),
      price: Number(it.price||0),
      status: st
    }));
  }
  return [{
    orderId: o.id,
    createdAt: dt,
    productName: o.productName || '(sem nome)',
    qty: Number(o.qty||1),
    price: Number(o.price||0),
    status: st
  }];
}

/* ---------- Realtime ---------- */
onSnapshot(query(colOrders(), orderBy("createdAt","desc")), snap=>{
  ORDERS = [];
  snap.forEach(d=> ORDERS.push({ id:d.id, ...d.data() }));
  applyFilters();
});

function applyFilters(){
  const r = $("range").value;
  const d1 = $("d1").value ? new Date($("d1").value) : null;
  const d2 = $("d2").value ? new Date($("d2").value) : null;

  let from = null;
  if (r !== "all"){ from = new Date(); from.setDate(from.getDate()-Number(r)); }

  FILTERED = ORDERS.filter(o=>{
    const dt = o.createdAt?.toDate?.() || new Date();
    if (from && dt < from) return false;
    if (d1 && dt < d1) return false;
    if (d2 && dt > new Date(d2.getTime()+24*60*60*1000)) return false; // inclui dia final
    return true;
  });

  // gera linhas p/ tabela e top produtos
  LINES = FILTERED.flatMap(orderToLines);

  renderKPIs();
  drawCharts();
  renderTable();
}

$("range").onchange = applyFilters;
$("d1").onchange = applyFilters;
$("d2").onchange = applyFilters;

/* ---------- KPIs ---------- */
function renderKPIs(){
  const total = FILTERED.reduce((s,o)=> s + orderTotal(o), 0);
  const count = FILTERED.length;
  const paid = FILTERED.filter(o=> (o.status||'pending')==='paid').length;
  const pend = FILTERED.filter(o=> (o.status||'pending')==='pending' || o.status==='new').length;
  const aov = count ? (total / count) : 0;

  $("k_rev").textContent = brl(total);
  $("k_orders").textContent = count;
  $("k_aov").textContent = brl(aov);
  $("k_status").textContent = `${paid} / ${pend}`;
}

/* ---------- Charts ---------- */
let chartRev, chartTop;

function drawCharts(){
  // Receita por dia (por pedido)
  const byDay = new Map();
  for(const o of FILTERED){
    const dt = (o.createdAt?.toDate?.() || new Date());
    const key = dt.toISOString().slice(0,10);
    byDay.set(key, (byDay.get(key)||0) + orderTotal(o));
  }
  const labels = Array.from(byDay.keys()).sort();
  const data   = labels.map(k => Number(byDay.get(k).toFixed(2)));

  if(chartRev) chartRev.destroy();
  chartRev = new Chart(document.getElementById('chartRev'),{
    type:'line',
    data:{ labels, datasets:[{ label:'Receita', data }] },
    options:{
      responsive:true,
      plugins:{legend:{display:false}, tooltip:{callbacks:{label:c=>'R$ '+c.parsed.y.toLocaleString('pt-BR')}}},
      scales:{ y:{ ticks:{ callback:v=>'R$ '+Number(v).toLocaleString('pt-BR') } } }
    }
  });

  // Top produtos (pelas linhas)
  const byProd = new Map();
  for(const ln of LINES){
    byProd.set(ln.productName, (byProd.get(ln.productName)||0) + ln.price*ln.qty);
  }
  const arr = Array.from(byProd.entries()).map(([name,val])=>({name,val}))
                   .sort((a,b)=>b.val-a.val).slice(0,8);
  const L = arr.map(x=>x.name);
  const D = arr.map(x=>Number(x.val.toFixed(2)));

  if(chartTop) chartTop.destroy();
  chartTop = new Chart(document.getElementById('chartTop'),{
    type:'bar',
    data:{ labels:L, datasets:[{ label:'Receita', data:D }] },
    options:{
      indexAxis:'y',
      plugins:{legend:{display:false}, tooltip:{callbacks:{label:c=>'R$ '+c.parsed.x.toLocaleString('pt-BR')}}},
      scales:{ x:{ ticks:{ callback:v=>'R$ '+Number(v).toLocaleString('pt-BR') } } }
    }
  });
}

/* ---------- Tabela ---------- */
const tb = $("tbody");
function renderTable(){
  tb.innerHTML = "";
  for(const ln of LINES){
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${ln.createdAt.toLocaleString('pt-BR')}</td>
      <td><code>${ln.orderId.slice(0,8)}</code></td>
      <td>${ln.productName}</td>
      <td>${ln.qty}</td>
      <td>${brl(ln.price*ln.qty)}</td>
      <td>
        <select data-id="${ln.orderId}">
          <option value="pending" ${(ln.status==='pending' || ln.status==='new')?'selected':''}>Pendente</option>
          <option value="paid" ${ln.status==='paid'?'selected':''}>Pago</option>
          <option value="canceled" ${ln.status==='canceled'?'selected':''}>Cancelado</option>
        </select>
      </td>
    `;
    tb.appendChild(tr);
  }

  tb.querySelectorAll("select").forEach(sel=>{
    sel.onchange = async (e)=>{
      const id = e.target.getAttribute("data-id");
      await updateDoc(doc(db, `tenants/${TENANT}/orders/${id}`), { status: e.target.value });
    };
  });
}

/* ---------- CSV ---------- */
$("btnCSV").onclick = ()=>{
  const rows = [["orderId","createdAt","productName","qty","price","lineTotal","status"]];
  for(const ln of LINES){
    rows.push([
      ln.orderId,
      ln.createdAt.toISOString(),
      ln.productName,
      ln.qty,
      ln.price,
      (ln.price*ln.qty).toFixed(2),
      ln.status
    ]);
  }
  const csv = rows.map(r=>r.map(v=>`"${String(v).replace(/"/g,'""')}"`).join(",")).join("\n");
  const blob = new Blob([csv],{type:"text/csv;charset=utf-8"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = `financeiro_${TENANT}.csv`;
  a.click();
};
</script>

<!-- Botão Voltar (fora do módulo) -->
<script>
  function getTenantFromPath(){
    const p = location.pathname.split('/').filter(Boolean);
    return (p.length>=2 && ['admin','catalogo','estoque','financeiro'].includes(p[1])) ? p[0] : null;
  }
  function adminUrl(){ const t=getTenantFromPath(); return t ? `/${t}/admin` : '/admin'; }
  function goBack(){
    try{
      const ref=document.referrer;
      if(ref && new URL(ref).origin===location.origin){ history.back(); return; }
    }catch(_){}
    location.href=adminUrl();
  }
</script>
</body>
</html>