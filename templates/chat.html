<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Painel de Conversas</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root { --primary:#3498db; --dark1:#2c3e50; --light1:#f4f4f4; --white:#fff; }
    body { margin:0; font-family:'Poppins',sans-serif; background:var(--light1); display:flex; height:100vh; }
    .sidebar { width:280px; background:var(--dark1); color:var(--white); display:flex; flex-direction:column; padding:15px; overflow-y:auto; }
    .sidebar h2 { font-size:18px; margin:0 0 15px; text-align:center; }
    .session { background:#34495e; padding:10px; border-radius:6px; margin-bottom:8px; cursor:pointer; transition:0.3s; }
    .session:hover { background:#3d566e; }
    .session.active { background:var(--primary); }
    .content { flex:1; display:flex; flex-direction:column; background:var(--white); }
    .chat-header { background:var(--primary); color:var(--white); padding:15px; font-weight:600; display:flex; justify-content:space-between; align-items:center; }
    .chat-messages { flex:1; padding:15px; overflow-y:auto; display:flex; flex-direction:column; }
    .msg { max-width:70%; padding:10px 14px; border-radius:12px; margin-bottom:10px; word-wrap:break-word; }
    .msg.user { background:#ecf0f1; align-self:flex-start; }
    .msg.admin { background:var(--primary); color:#fff; align-self:flex-end; }
    .chat-input { display:flex; border-top:1px solid #ddd; padding:10px; }
    .chat-input input { flex:1; border:1px solid #ccc; border-radius:8px; padding:10px; font-size:14px; }
    .chat-input button { margin-left:8px; background:var(--primary); color:#fff; border:none; border-radius:8px; padding:10px 18px; cursor:pointer; font-weight:600; }
    @media (max-width:768px) {
      body { flex-direction:column; }
      .sidebar { width:100%; height:200px; flex-direction:row; overflow-x:auto; }
      .session { min-width:180px; margin-right:10px; }
      .content { flex:1; height:calc(100vh - 200px); }
    }
  </style>
</head>
<body>

  <div class="sidebar">
    <h2>Conversas</h2>
    <div id="sessions">Carregando...</div>
  </div>

  <div class="content">
    <div class="chat-header" id="chat-header">Selecione uma conversa</div>
    <div class="chat-messages" id="chat-messages"></div>
    <div class="chat-input">
      <input type="text" id="chat-text" placeholder="Digite sua mensagem..." disabled>
      <button onclick="sendMessage()" id="send-btn" disabled>Enviar</button>
    </div>
  </div>

  <script type="module">
    // Função utilitária para chamadas à API sem Auth
    async function apiJson(url, options = {}) {
      try {
        const res = await fetch(url, {
          method: options.method || "GET",
          credentials: "include",
          headers: {
            "Content-Type": "application/json",
            ...(options.headers || {})
          },
          body: options.body || undefined
        });
        const data = await res.json().catch(() => null);
        if (!res.ok) {
          console.error(`API error ${res.status} @ ${url}`, data);
          throw new Error(`${url} -> ${res.status}`);
        }
        return data;
      } catch (err) {
        console.error("Network/Parse error @", url, err);
        throw err;
      }
    }

    let selectedSession = null;

    // Carregar sessões
    async function loadSessions() {
      try {
        const sessions = await apiJson("/sessions");
        const list = document.getElementById("sessions");
        list.innerHTML = "";

        if (!Array.isArray(sessions) || sessions.length === 0) {
          list.innerHTML = "<div>Nenhuma sessão encontrada.</div>";
          return;
        }

        sessions.forEach(s => {
          const id = s.id || s.sessionId || s._id || String(s);
          const div = document.createElement("div");
          div.className = "session" + (id === selectedSession ? " active" : "");
          div.textContent = `Sessão: ${String(id).substring(0,6)}...`;
          div.onclick = () => selectSession(id);
          list.appendChild(div);
        });
      } catch (_) {}
    }

    // Selecionar conversa
    async function selectSession(id) {
      selectedSession = id;
      document.getElementById("chat-header").textContent = "Conversando com: " + id;
      document.getElementById("chat-text").disabled = false;
      document.getElementById("send-btn").disabled = false;
      loadMessages();
    }

    // Carregar mensagens
    async function loadMessages() {
      if (!selectedSession) return;
      try {
        const data = await apiJson(`/get_messages?sessionId=${encodeURIComponent(selectedSession)}`);
        const msgs = Array.isArray(data) ? data : (data?.messages || []);
        const box = document.getElementById("chat-messages");
        box.innerHTML = "";

        if (!msgs.length) {
          const empty = document.createElement("div");
          empty.style.opacity = ".7";
          empty.textContent = "Sem mensagens ainda.";
          box.appendChild(empty);
          return;
        }

        msgs.forEach(m => {
          const txt = m.text ?? m.message ?? m.content ?? "";
          const who = (m.sender ?? m.role ?? "user") === "user" ? "user" : "admin";
          const div = document.createElement("div");
          div.className = "msg " + who;
          div.textContent = txt;
          box.appendChild(div);
        });
        box.scrollTop = box.scrollHeight;
      } catch (_) {}
    }

    // Enviar mensagem
    async function sendMessage() {
      const input = document.getElementById("chat-text");
      const btn = document.getElementById("send-btn");
      const text = input.value.trim();
      if (!text || !selectedSession) return;

      btn.disabled = true;

      // mostra de forma otimista
      const box = document.getElementById("chat-messages");
      const preview = document.createElement("div");
      preview.className = "msg admin";
      preview.textContent = text;
      box.appendChild(preview);
      box.scrollTop = box.scrollHeight;

      try {
        await apiJson("/send_message", {
          method: "POST",
          body: JSON.stringify({ sessionId: selectedSession, text, sender: "admin" })
        });
      } catch (e) {
        try {
          await apiJson(`/send_message?sessionId=${encodeURIComponent(selectedSession)}`, {
            method: "POST",
            body: JSON.stringify({ text, sender: "admin" })
          });
        } catch (e2) {
          console.error("Falha ao enviar mensagem.", e2);
        }
      } finally {
        input.value = "";
        btn.disabled = false;
        loadMessages();
      }
    }
    window.sendMessage = sendMessage;

    // Inicialização simples (sem Firebase Auth)
    loadSessions();
    setInterval(() => { loadSessions(); loadMessages(); }, 3000);
  </script>
</body>
</html>
